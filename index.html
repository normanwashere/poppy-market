<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poppy Platform</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-lavender: #E6E0F8;
            --primary-mint: #C1E1C1; /* Green for Locked/Approved */
            --primary-lavender: #D6C6E4;
            --action-pink: #FFC0CB;
            --action-yellow: #FDFD96; /* Yellow for Pending */
            --action-red: #FFB3B3;    /* Red for Needs Takeover */
            --text-dark: #3D3D3D;
            --shadow-light: rgba(255, 255, 255, 0.7);
            --shadow-dark: rgba(0, 0, 0, 0.15);
            --highlight-today: rgba(214, 198, 228, 0.5);
            --zebra-stripe: rgba(0,0,0,0.04);
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--bg-lavender); color: var(--text-dark); }
        .font-playfair { font-family: 'Playfair Display', serif; }
        .clay-card { border-radius: 20px; background: var(--bg-lavender); box-shadow: -8px -8px 16px var(--shadow-light), 8px 8px 16px var(--shadow-dark); }
        .clay-inset { border-radius: 16px; background: var(--bg-lavender); box-shadow: inset -4px -4px 8px var(--shadow-light), inset 4px 4px 8px var(--shadow-dark); }
        .clay-button { border-radius: 16px; background: var(--bg-lavender); font-weight: 700; transition: all 0.1s ease-in-out; box-shadow: -6px -6px 12px var(--shadow-light), 6px 6px 12px var(--shadow-dark); }
        .clay-button:active { transform: scale(0.98); box-shadow: -2px -2px 6px var(--shadow-light), 2px 2px 6px var(--shadow-dark); }
        .clay-button-primary { background-color: var(--action-pink); }
        .clay-button-approve { background-color: var(--primary-mint); }
        .clay-button-deny { background-color: var(--action-red); }
        .fc { border: none; }
        .fc .fc-toolbar-title { font-family: 'Playfair Display', serif; color: var(--text-dark); font-size: 1.25rem; }
        .fc .fc-button-primary { background-color: var(--primary-lavender) !important; border: none !important; box-shadow: -2px -2px 6px var(--shadow-light), 2px 2px 6px var(--shadow-dark) !important; }
        .fc .fc-button-primary:active { box-shadow: inset -2px -2px 6px var(--shadow-light), inset 2px 2px 6px var(--shadow-dark) !important; }
        .fc .fc-daygrid-day-frame { border-radius: 16px; transition: background-color 0.2s; }
        .fc .fc-daygrid-day:hover .fc-daygrid-day-frame { background-color: rgba(255, 255, 255, 0.4); }
        .fc .fc-daygrid-day-number { padding: 8px; }
        .fc .fc-day-today .fc-daygrid-day-frame { background-color: var(--highlight-today); }
        .fc-event { border: none !important; border-radius: 10px !important; padding: 4px 8px !important; box-shadow: -3px -3px 8px var(--shadow-light), 3px 3px 8px var(--shadow-dark) !important; cursor: pointer; }
        .fc-event-main { font-weight: 600; color: var(--text-dark) !important; }
        .fc-event.event-locked { background-color: var(--primary-mint) !important; }
        .fc-event.event-pending { background-color: var(--action-yellow) !important; }
        .fc-event.event-takeover { background-color: var(--action-red) !important; }
        .tooltip-container { position: relative; display: inline-block; }
        .tooltip-text { visibility: hidden; width: 200px; background-color: #555; color: #fff; text-align: left; border-radius: 6px; padding: 8px; position: absolute; z-index: 10; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s; }
        .tooltip-text::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #555 transparent transparent transparent; }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        #loader { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; background-color: var(--bg-lavender); transition: opacity 0.5s ease-out; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 48px; height: 48px; border-radius: 50%; border-left-color: var(--text-dark); animation: spin 1s ease infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loader-text { font-size: 1.5rem; font-family: 'Playfair Display', serif; margin-top: 1.5rem; color: var(--text-dark); }
        #loader.hidden { opacity: 0; pointer-events: none; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div id="loader">
        <div class="spinner"></div>
        <div class="loader-text">Loading Poppy Platform...</div>
    </div>

    <header id="main-header" class="hidden clay-card p-4 mb-8 sticky top-4 z-40">
        <nav class="flex flex-wrap items-center justify-between gap-4">
            <div id="nav-links" class="flex items-center gap-2"></div>
            <div class="relative">
                <button id="profile-button" class="flex items-center gap-3">
                    <div class="bg-white p-2 rounded-full shadow-inner">
                        <img src="https://dgtalbay.static.domains/Profile%20pic.png" alt="Profile Picture" class="h-6 w-6 object-cover rounded-full">
                    </div>
                    <span id="profile-name" class="font-playfair font-bold text-xl"></span>
                </button>
                <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 clay-card p-2 z-50"></div>
            </div>
        </nav>
    </header>

    <div id="app-container" class="hidden"></div>
    <div id="modal-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script type="module">
        const { createClient } = supabase;
        const SUPABASE_URL = 'https://lmzxjxumfqjrvcnsrfbr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxtenhqeHVtZnFqcnZjbnNyZmJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1MDUzNDIsImV4cCI6MjA2NjA4MTM0Mn0.7vd1mZzXKYjf64b_lRmPUR0KM_4VdgJMxsDVrCEYbTw';
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- TEMPLATES (Pages & Modals) ---
        // Note: For true lazy loading, these templates would ideally be loaded from separate files
        // when showPage() is called. For a single-file solution, they are here, but
        // deferring the main script ensures they don't block initial render.
        const pageTemplates = {
            login: `<div class="w-full max-w-md mx-auto"><header class="text-center mb-8"><div class="inline-block bg-white p-4 rounded-full shadow-md mb-4 clay-card"><img src="https://dgtalbay.static.domains/icon2.png" alt="Poppy Platform Icon" class="w-10 h-10"></div><h1 class="font-playfair text-4xl sm:text-5xl font-bold text-gray-700">Welcome Back</h1><p class="text-gray-500 mt-2">Log in to access your dashboard.</p></header><form id="login-form" class="clay-card p-6 sm:p-8 space-y-6"><div><label for="login-email" class="block text-sm font-medium mb-2">Email Address</label><input type="email" id="login-email" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none" required></div><div><label for="login-password" class="block text-sm font-medium mb-2">Password</label><input type="password" id="login-password" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none" required></div><div class="pt-2"><button type="submit" class="clay-button clay-button-primary w-full p-4 text-xl text-gray-800">Login</button></div></form><div class="text-center mt-6"><p class="text-sm">Don't have an account? <a href="#" data-page="signup" class="font-semibold hover:underline" style="color: #831843;">Sign Up</a></p></div></div>`,
            signup: `<div class="w-full max-w-md mx-auto"><header class="text-center mb-8"><h1 class="font-playfair text-4xl sm:text-5xl font-bold text-gray-700">Create Your Account</h1><p class="text-gray-500 mt-2">Join the Poppy Platform.</p></header><form id="signup-form" class="clay-card p-6 sm:p-8 space-y-6"><div><label for="fullname" class="block text-sm font-medium mb-2">Full Name</label><input type="text" id="fullname" name="fullname" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none" required></div><div><label for="email" class="block text-sm font-medium mb-2">Email Address</label><input type="email" id="email" name="email" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none" required></div><div><label for="password" class="block text-sm font-medium mb-2">Password</label><input type="password" id="password" name="password" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none" required></div><div class="pt-2"><button type="submit" class="clay-button clay-button-primary w-full p-4 text-xl text-gray-800">Create Account</button></div></form><div class="text-center mt-6"><p class="text-sm">Already have an account? <a href="#" data-page="login" class="font-semibold hover:underline" style="color: #831843;">Login</a></p></div></div>`,
            dashboard: `<div class="w-full max-w-7xl mx-auto"><header class="text-center mb-8"><h1 id="dashboard-title" class="font-playfair text-4xl sm:text-5xl font-bold text-gray-700"></h1><p id="dashboard-subtitle" class="text-gray-500 mt-2"></p></header><div id="dashboard-container"></div></div>`,
            scheduler: `<div class="w-full max-w-7xl mx-auto"><header class="text-center mb-8"><h1 class="font-playfair text-4xl sm:text-5xl font-bold text-gray-700">Live Session Scheduler</h1><p class="text-gray-500 mt-2">Book your upcoming live sessions.</p></header><div class="clay-card p-2 sm:p-6 mb-8"><div id='calendar'></div></div></div>`,
            userManagement: `<div class="w-full max-w-4xl mx-auto"><header class="text-center mb-8"><h1 class="font-playfair text-4xl sm:text-5xl font-bold text-gray-700">User Management</h1><p class="text-gray-500 mt-2">Approve new seller accounts and manage existing users.</p></header><div id="user-list-container" class="clay-card overflow-hidden"></div></div>`,
            bonusRules: `<div class="w-full max-w-5xl mx-auto"><header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4"><div class="text-center sm:text-left"><h1 class="font-playfair text-4xl sm:text-5xl font-bold text-gray-700">Bonus Rules</h1><p class="text-gray-500 mt-2">Create and manage performance-based bonus schemes.</p></div><button id="create-new-rule-btn" class="clay-button clay-button-primary w-full sm:w-auto px-6 py-4 text-lg">Create New Rule</button></header><div id="bonus-rules-list" class="space-y-4"></div></div>`,
            bonusReview: `<div class="w-full max-w-5xl mx-auto"><header class="text-center mb-8"><h1 class="font-playfair text-4xl sm:text-5xl font-bold text-gray-700">Bonus Review</h1><p class="text-gray-500 mt-2">Review and manage achieved bonuses.</p></header><div id="bonus-review-list" class="space-y-4"></div></div>`,
            globalSettings: `<div class="w-full max-w-4xl mx-auto"><header class="text-center mb-8"><h1 class="font-playfair text-4xl sm:text-5xl font-bold text-gray-700">Global Settings</h1><p class="text-gray-500 mt-2">Configure platform-wide operational parameters.</p></header><div id="settings-list" class="space-y-4"></div></div>`,
            ruleSetManagement: `<div class="w-full max-w-6xl mx-auto"><header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4"><div class="text-center sm:text-left"><h1 class="font-playfair text-4xl sm:text-5xl font-bold text-gray-700">Rule Set Management</h1><p class="text-gray-500 mt-2">Define and manage compensation rule sets.</p></div><button id="create-new-ruleset-btn" class="clay-button clay-button-primary w-full sm:w-auto px-6 py-4 text-lg">Create New Rule Set</button></header><div id="rulesets-list" class="space-y-4"></div></div>`,
            userProfile: `<div class="w-full max-w-2xl mx-auto"><header class="text-center mb-8"><h1 class="font-playfair text-4xl sm:text-5xl font-bold text-gray-700">Profile</h1><p class="text-gray-500 mt-2">Update your personal information and password.</p></header><form id="profile-info-form" class="clay-card p-6 sm:p-8 space-y-8 mb-8"><fieldset><legend class="font-playfair text-2xl font-bold mb-4">Contact Information</legend><div class="grid grid-cols-1 sm:grid-cols-2 gap-6"><div><label for="profile-gcash" class="block text-sm font-medium mb-2">GCash Number</label><input type="text" id="profile-gcash" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none"></div><div><label for="profile-contact" class="block text-sm font-medium mb-2">Contact Number</label><input type="text" id="profile-contact" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none"></div><div class="sm:col-span-2"><label for="profile-emergency" class="block text-sm font-medium mb-2">Emergency Contact</label><input type="text" id="profile-emergency" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none"></div></div></fieldset><div class="pt-2"><button type="submit" class="clay-button clay-button-primary w-full p-4 text-xl text-gray-800">Save Information</button></div></form><form id="password-change-form" class="clay-card p-6 sm:p-8 space-y-8"><fieldset><legend class="font-playfair text-2xl font-bold mb-4">Change Password</legend><div class="space-y-6"><div><label for="profile-new-password" class="block text-sm font-medium mb-2">New Password</label><input type="password" id="profile-new-password" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none"></div><div><label for="profile-confirm-password" class="block text-sm font-medium mb-2">Confirm New Password</label><input type="password" id="profile-confirm-password" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none"></div></div></fieldset><div class="pt-2"><button type="submit" class="clay-button clay-button-primary w-full p-4 text-xl text-gray-800">Change Password</button></div></div></form>`
        };
        const modalTemplates = {
            alert: `<div id="alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div class="clay-card w-full max-w-sm p-6 sm:p-8 text-center"><h2 id="alert-title" class="font-playfair text-2xl font-bold text-gray-700 mb-4"></h2><p id="alert-message" class="text-gray-600 mb-6"></p><button type="button" id="alert-ok-btn" class="clay-button clay-button-primary w-full p-3 text-lg text-gray-800">OK</button></div></div>`,
            logSession: `<div id="log-session-modal" class="hidden fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div class="clay-card w-full max-w-2xl p-6 sm:p-8"><h2 class="font-playfair text-3xl font-bold text-gray-700 mb-6">Log New Session</h2><form id="session-log-form" class="space-y-8"><fieldset class="grid grid-cols-1 sm:grid-cols-2 gap-6"><legend class="sr-only">Session Start and End Time</legend><div><label for="session-start" class="block text-sm font-medium mb-2">Session Start</label><input type="datetime-local" id="session-start" name="session-start" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none" required></div><div><label for="session-end" class="block text-sm font-medium mb-2">Session End</label><input type="datetime-local" id="session-end" name="session-end" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none" required></div></fieldset><fieldset><legend class="font-playfair text-2xl font-bold mb-4">Items Sold</legend><div class="grid grid-cols-1 sm:grid-cols-2 gap-6"><div><label for="branded-items" class="block text-sm font-medium mb-2">Branded Items</label><input type="number" id="branded-items" name="branded-items" value="0" min="0" placeholder="0" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none"></div><div><label for="free-size-items" class="block text-sm font-medium mb-2">Free Size Items</label><input type="number" id="free-size-items" name="free-size-items" value="0" min="0" placeholder="0" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none"></div></div></fieldset><div class="pt-4 flex flex-col sm:flex-row gap-4"><button type="submit" class="clay-button clay-button-primary w-full p-4 text-xl text-gray-800">Submit Log</button><button type="button" id="cancel-log-session-btn" class="clay-button w-full p-4 text-xl text-gray-700">Cancel</button></div></form></div></div>`,
            booking: `<div id="booking-modal" class="hidden fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div class="clay-card w-full max-w-lg p-6 sm:p-8"><h2 class="font-playfair text-3xl font-bold text-gray-700 mb-4">Book Session</h2><form id="booking-form" class="space-y-6"><div><label for="event-title" class="block text-sm font-medium mb-2">Your Name</label><input type="text" id="event-title" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none" required readonly></div><div><label for="start-time" class="block text-sm font-medium mb-2">Session Start Time</label><input type="time" id="start-time" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none" required></div><p class="text-center text-sm font-semibold h-4 text-gray-600">Session will be booked for 3 hours.</p><div class="pt-4 flex flex-col sm:flex-row gap-4"><button type="submit" id="book-session-btn" class="clay-button clay-button-primary w-full p-4 text-xl text-gray-800">Request Booking</button><button type="button" id="cancel-booking-btn" class="clay-button w-full p-4 text-xl text-gray-700">Cancel</button></div></form></div></div>`,
            eventDetails: `<div id="event-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div class="clay-card w-full max-w-lg p-6 sm:p-8"><h2 id="event-details-title" class="font-playfair text-3xl font-bold text-gray-700 mb-2"></h2><p id="event-details-time" class="text-gray-600 mb-1"></p><p id="event-details-status" class="text-sm font-semibold mb-6"></p><div id="event-details-actions" class="pt-4 flex flex-col sm:flex-row gap-4"></div><button type="button" id="close-details-btn" class="clay-button w-full p-4 text-xl text-gray-700 mt-4">Close</button></div></div>`,
            userDetails: `<div id="user-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div class="clay-card w-full max-w-lg p-6 sm:p-8"><h2 id="user-details-name" class="font-playfair text-3xl font-bold text-gray-700 mb-6"></h2><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-500">GCash Number</label><p id="user-details-gcash" class="clay-inset w-full p-4 text-lg"></p></div><div><label class="block text-sm font-medium text-gray-500">Contact Number</label><p id="user-details-contact" class="clay-inset w-full p-4 text-lg"></p></div><div><label class="block text-sm font-medium text-gray-500">Emergency Contact</label><p id="user-details-emergency" class="clay-inset w-full p-4 text-lg"></p></div></div><button type="button" id="close-user-details-btn" class="clay-button w-full p-4 text-xl text-gray-700 mt-8">Close</button></div></div>`,
            createBonusRule: `<div id="create-bonus-rule-modal" class="hidden fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div class="clay-card w-full max-w-3xl p-6 sm:p-8 flex flex-col max-h-[95vh]"><h2 class="font-playfair text-3xl font-bold text-gray-700 mb-6 flex-shrink-0">Create New Bonus Rule</h2><form id="bonus-rule-form" class="space-y-6 overflow-y-auto pr-2"><div class="clay-card p-6"><h3 class="font-playfair text-xl font-bold mb-4">Basic Information</h3><div class="space-y-4"><div><label for="rule-name" class="block text-sm font-medium mb-1">Rule Name</label><input type="text" id="rule-name" placeholder="e.g., Monthly Excellence Bonus" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none" required></div><div><label for="rule-description" class="block text-sm font-medium mb-1">Description</textarea><textarea id="rule-description" placeholder="Brief description of the bonus requirements" rows="3" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none"></textarea></div></div></div><div class="clay-card p-6"><h3 class="font-playfair text-xl font-bold mb-4">Active Period</h3><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="effective-start-date" class="block text-sm font-medium mb-1">Effective Start Date</label><input type="date" id="effective-start-date" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none" required></div><div><label for="effective-end-date" class="block text-sm font-medium mb-1">Effective End Date</label><input type="date" id="effective-end-date" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none"></div></div></div><div class="clay-card p-6"><h3 class="font-playfair text-xl font-bold mb-4">Target Requirements (All must be met)</h3><div class="grid grid-cols-1 sm:grid-cols-3 gap-4"><div><label for="rule-live-hours" class="block text-sm font-medium mb-1">Live Hours Target</label><input type="number" id="rule-live-hours" placeholder="e.g., 40" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none" required></div><div><label for="rule-branded-items" class="block text-sm font-medium mb-1">Branded Items Target</label><input type="number" id="rule-branded-items" placeholder="e.g., 60" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none" required></div><div><label for="rule-free-size" class="block text-sm font-medium mb-1">Free Size Target</label><input type="number" id="rule-free-size" placeholder="e.g., 100" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none" required></div></div></div><div class="clay-card p-6"><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="rule-time-frame" class="block text-sm font-medium mb-1">Time Frame</label><select id="rule-time-frame" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none" required><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly">Monthly</option><option value="quarterly">Quarterly</option><option value="one-time">One-Time</option></select></div><div><label for="rule-bonus-amount" class="block text-sm font-medium mb-1">Bonus Amount (₱)</label><input type="number" step="0.01" id="rule-bonus-amount" placeholder="0.00" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none" required></div><div><label for="rule-reset-day" class="block text-sm font-medium mb-1">Reset Day (for weekly/monthly)</label><input type="text" id="rule-reset-day" placeholder="e.g., Monday or 1st_of_month" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none"></div></div></div><div class="pt-4 flex flex-col sm:flex-row gap-4 flex-shrink-0"><button type="submit" class="clay-button clay-button-primary w-full p-4 text-xl text-gray-800">Create Rule</button><button type="button" id="cancel-bonus-rule-btn" class="clay-button w-full p-4 text-xl text-gray-700">Cancel</button></div></form></div></div>`,
            deleteConfirmation: `<div id="delete-confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div class="clay-card w-full max-w-md p-6 sm:p-8 text-center"><h2 class="font-playfair text-2xl font-bold text-gray-700 mb-4">Confirm Deletion</h2><p id="delete-confirm-message" class="text-gray-600 mb-6"></p><form id="delete-confirm-form"><div class="pt-6 flex flex-col sm:flex-row gap-4"><button type="submit" id="confirm-delete-btn" class="clay-button clay-button-deny w-full p-4 text-xl">Delete</button><button type="button" id="cancel-delete-btn" class="clay-button w-full p-4 text-xl">Cancel</button></div></form></div></div>`,
            passwordConfirm: `<div id="password-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div class="clay-card w-full max-w-md p-6 sm:p-8 text-center"><h2 class="font-playfair text-2xl font-bold text-gray-700 mb-4">Confirm Deletion with Password</h2><p class="text-gray-600 mb-6">Please enter your password to confirm this action. This cannot be undone.</p><form id="password-confirm-form" class="space-y-4"><div><label for="delete-password-input" class="block text-sm font-medium mb-2">Password</label><input type="password" id="delete-password-input" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none" required></div><div class="pt-4 flex flex-col sm:flex-row gap-4"><button type="submit" class="clay-button clay-button-deny w-full p-4 text-xl">Confirm Delete</button><button type="button" id="cancel-password-confirm-btn" class="clay-button w-full p-4 text-xl">Cancel</button></div></form></div></div>`,
            bonusRuleDetails: `<div id="bonus-rule-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div class="clay-card w-full max-w-2xl p-6 sm:p-8"><h2 id="bonus-details-name" class="font-playfair text-3xl font-bold text-gray-700 mb-2"></h2><p id="bonus-details-description" class="text-gray-600 mb-6"></p><div class="space-y-4"><div class="clay-card p-4"><h3 class="font-playfair text-xl font-bold mb-2">Targets</h3><ul id="bonus-details-targets" class="list-disc list-inside space-y-1"></ul></div><div class="clay-card p-4"><h3 class="font-playfair text-xl font-bold mb-2">Details</h3><div class="grid grid-cols-2 gap-4"><p><strong>Bonus:</strong> <span id="bonus-details-amount"></span></p><p><strong>Time Frame:</strong> <span id="bonus-details-timeframe"></span></p><p><strong>Starts:</strong> <span id="bonus-details-start"></span></p><p><strong>Ends:</strong> <span id="bonus-details-end"></span></p></div></div></div><button type="button" id="close-bonus-details-btn" class="clay-button w-full p-4 text-xl text-gray-700 mt-8">Close</button></div></div>`,
            reviewBonusModal: `<div id="review-bonus-modal" class="hidden fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div class="clay-card w-full max-w-lg p-6 sm:p-8"><h2 id="review-bonus-title" class="font-playfair text-3xl font-bold text-gray-700 mb-2">Review Bonus</h2><p id="review-bonus-details" class="text-gray-600 mb-4"></p><form id="review-bonus-form" class="space-y-4"><div class="mb-4"><label for="review-bonus-notes" class="block text-sm font-medium mb-2">Admin Notes (required for rejection)</label><textarea id="review-bonus-notes" rows="4" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none"></textarea></div><div class="pt-4 flex flex-col sm:flex-row gap-4"><button type="submit" id="approve-bonus-action-btn" class="clay-button clay-button-approve w-full p-4 text-xl">Approve Bonus</button><button type="submit" id="reject-bonus-action-btn" class="clay-button clay-button-deny w-full p-4 text-xl">Reject Bonus</button><button type="button" id="cancel-review-bonus-btn" class="clay-button w-full p-4 text-xl text-gray-700">Cancel</button></div></form></div></div>`,
            finalizeSession: `<div id="finalize-session-modal" class="hidden fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div class="clay-card w-full max-w-2xl p-6 sm:p-8"><h2 class="font-playfair text-3xl font-bold text-gray-700 mb-6">Finalize Session</h2><p class="text-gray-600 mb-4">Session ended. Please log your sales data below.</p><p id="final-session-duration" class="text-lg font-semibold text-gray-700 mb-6 text-center"></p><form id="finalize-session-form" class="space-y-8"><fieldset><legend class="font-playfair text-2xl font-bold mb-4">Items Sold</legend><div class="grid grid-cols-1 sm:grid-cols-2 gap-6"><div><label for="finalize-branded-items" class="block text-sm font-medium mb-2">Branded Items</label><input type="number" id="finalize-branded-items" name="branded-items" value="0" min="0" placeholder="0" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none"></div><div><label for="finalize-free-size-items" class="block text-sm font-medium mb-2">Free Size Items</label><input type="number" id="finalize-free-size-items" name="free-size-items" value="0" min="0" placeholder="0" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none"></div></div></fieldset><fieldset><legend class="font-playfair text-2xl font-bold mb-4">Additional Details</legend><div><label for="finalize-total-revenue" class="block text-sm font-medium mb-2">Total Revenue (₱)</label><input type="number" step="0.01" id="finalize-total-revenue" name="total-revenue" value="0.00" min="0" placeholder="0.00" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none"></div><div><label for="finalize-session-notes" class="block text-sm font-medium mb-2">Session Notes</label><textarea id="finalize-session-notes" name="session-notes" rows="3" class="clay-inset w-full p-4 text-lg appearance-none focus:outline-none" placeholder="Any important notes about the session..."></textarea></div></fieldset><div class="pt-4 flex flex-col sm:flex-row gap-4"><button type="submit" class="clay-button clay-button-primary w-full p-4 text-xl text-gray-800">Submit Sales Data</button><button type="button" id="cancel-finalize-session-btn" class="clay-button w-full p-4 text-xl text-gray-700">Cancel</button></div></form></div></div>`,
            createRuleSet: `<div id="create-ruleset-modal" class="hidden fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div class="clay-card w-full max-w-lg p-6 sm:p-8"><h2 class="font-playfair text-3xl font-bold text-gray-700 mb-6">Create New Rule Set</h2><form id="ruleset-form" class="space-y-6"><div><label for="ruleset-name" class="block text-sm font-medium mb-2">Rule Set Name</label><input type="text" id="ruleset-name" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none" required></div><div><label for="ruleset-description" class="block text-sm font-medium mb-2">Description</label><textarea id="ruleset-description" rows="3" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none"></textarea></div><div><label for="ruleset-type" class="block text-sm font-medium mb-2">Rule Type</label><select id="ruleset-type" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none" required></select></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="ruleset-start-date" class="block text-sm font-medium mb-2">Effective Start Date</label><input type="date" id="ruleset-start-date" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none" required></div><div><label for="ruleset-end-date" class="block text-sm font-medium mb-2">Effective End Date</label><input type="date" id="ruleset-end-date" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none"></div></div><div class="pt-4 flex flex-col sm:flex-row gap-4"><button type="submit" class="clay-button clay-button-primary w-full p-4 text-xl text-gray-800">Create Rule Set</button><button type="button" id="cancel-ruleset-btn" class="clay-button w-full p-4 text-xl text-gray-700">Cancel</button></div></form></div></div>`,
            editRule: `<div id="edit-rule-modal" class="hidden fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div class="clay-card w-full max-w-lg p-6 sm:p-8"><h2 class="font-playfair text-3xl font-bold text-gray-700 mb-6">Edit Rule</h2><form id="edit-rule-form" class="space-y-6"><div><label for="edit-rule-name" class="block text-sm font-medium mb-2">Rule Name</label><input type="text" id="edit-rule-name" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none" required></div><div><label for="edit-criteria-field" class="block text-sm font-medium mb-2">Criteria Field</label><select id="edit-criteria-field" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none" required><option value="live_hours">Live Hours</option><option value="branded_items">Branded Items</option><option value="free_size_items">Free Size Items</option><option value="total_revenue">Total Revenue</option></select></div><div><label for="edit-operator" class="block text-sm font-medium mb-2">Operator</label><select id="edit-operator" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none" required><option value=">=">>=</option><option value=">">></option><option value="=">=</option><option value="<"><</option><option value="<="><=</option></select></div><div><label for="edit-target-value" class="block text-sm font-medium mb-2">Target Value</label><input type="number" step="0.01" id="edit-target-value" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none" required></div><div><label for="edit-payout-type" class="block text-sm font-medium mb-2">Payout Type</label><select id="edit-payout-type" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none" required><option value="fixed_amount">Fixed Amount</option><option value="percentage">Percentage</option><option value="per_unit">Per Unit</option></select></div><div><label for="edit-payout-value" class="block text-sm font-medium mb-2">Payout Value</label><input type="number" step="0.01" id="edit-payout-value" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none" required></div><div><label for="edit-cadence" class="block text-sm font-medium mb-2">Cadence (Optional)</label><select id="edit-cadence" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none"><option value="">None</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly">Monthly</option><option value="quarterly">Quarterly</option><option value="one-time">One-Time</option></select></div><div><label for="edit-priority" class="block text-sm font-medium mb-2">Priority (Lower is higher priority)</label><input type="number" id="edit-priority" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none"></div><div class="pt-4 flex flex-col sm:flex-row gap-4"><button type="submit" class="clay-button clay-button-primary w-full p-4 text-xl text-gray-800">Save Rule</button><button type="button" id="cancel-edit-rule-btn" class="clay-button w-full p-4 text-xl text-gray-700">Cancel</button></div></form></div></div>`,
            viewRuleSetDetails: `<div id="view-ruleset-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div class="clay-card w-full max-w-4xl p-6 sm:p-8 flex flex-col max-h-[95vh]"><h2 id="view-ruleset-name" class="font-playfair text-3xl font-bold text-gray-700 mb-2"></h2><p id="view-ruleset-description" class="text-gray-600 mb-4"></p><div class="mb-4 text-sm text-gray-500"><span id="view-ruleset-status"></span> | <span id="view-ruleset-dates"></span></div><div class="pt-4 flex flex-col sm:flex-row gap-4 flex-shrink-0 mb-6"><button id="add-rule-to-ruleset-btn" class="clay-button clay-button-primary w-full sm:w-auto px-6 py-4 text-lg">Add Rule</button><button id="toggle-ruleset-active-btn" class="clay-button clay-button-approve w-full sm:w-auto px-6 py-4 text-lg">Toggle Active</button><button id="delete-ruleset-btn" class="clay-button clay-button-deny w-full sm:w-auto px-6 py-4 text-lg">Delete Rule Set</button></div><div class="overflow-y-auto pr-2 flex-grow"><h3 class="font-playfair text-2xl font-bold text-gray-700 mb-4">Rules in this Set</h3><div id="rules-in-set-list" class="space-y-3"></div></div><button type="button" id="close-ruleset-details-btn" class="clay-button w-full p-4 text-xl text-gray-700 mt-8 flex-shrink-0">Close</button></div></div>`,
        };

        // --- Global State & App Variables ---
        const loader = document.getElementById('loader');
        const appContainer = document.getElementById('app-container');
        const modalContainer = document.getElementById('modal-container');
        const mainHeader = document.getElementById('main-header');
        const navLinksContainer = document.getElementById('nav-links');
        const profileDropdown = document.getElementById('profile-dropdown');
        const profileButton = document.getElementById('profile-button');
        const profileName = document.getElementById('profile-name');

        let calendarInstance = null;
        let channels = [];
        let state = {
            isLoggedIn: false,
            currentUser: null,
            profile: null,
            currentPage: 'login',
            ruleToDelete: null,
            activeLiveSession: null, // This will now track the live_sessions.id
            currentRuleSetId: null,
            globalSettings: {},
        };

        // --- Global Helper Functions ---
        const showAlert = (title, message, onOk) => {
            const modal = document.getElementById('alert-modal');
            if (!modal) return;
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            modal.classList.remove('hidden');
            const okBtn = document.getElementById('alert-ok-btn');
            okBtn.onclick = () => {
                modal.classList.add('hidden');
                if (onOk) onOk();
            };
        };

        const setLoading = (isLoading) => {
            if (isLoading) {
                loader.classList.remove('hidden');
                appContainer.classList.add('hidden');
            } else {
                loader.classList.add('hidden');
                appContainer.classList.remove('hidden');
            }
        };
        const parseDateAsUTC = (dateString) => {
            if (!dateString) return null;
            const d = new Date(dateString.trim());
            if (isNaN(d.getTime())) return null;
            return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
        };
        const getWeekRange = (weekType) => {
            const today = new Date();
            const dayOfWeek = today.getUTCDay();
            let endOfWeek = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
            const daysUntilTuesday = (2 - dayOfWeek + 7) % 7;
            endOfWeek.setUTCDate(endOfWeek.getUTCDate() + daysUntilTuesday);
            if (weekType === 'last') endOfWeek.setUTCDate(endOfWeek.getUTCDate() - 7);
            let startOfWeek = new Date(endOfWeek);
            startOfWeek.setUTCDate(startOfWeek.getUTCDate() - 6);
            startOfWeek.setUTCHours(0, 0, 0, 0);
            endOfWeek.setUTCHours(23, 59, 59, 999);
            return { start: startOfWeek, end: endOfWeek };
        };
        const getMonthRange = (monthType) => {
            const today = new Date();
            let year = today.getUTCFullYear();
            let month = today.getUTCMonth();
            if (monthType === 'last') {
                month -= 1;
                if (month < 0) { month = 11; year -= 1; }
            }
            const start = new Date(Date.UTC(year, month, 1));
            const end = new Date(Date.UTC(year, month + 1, 0));
            end.setUTCHours(23,59,59,999);
            return { start, end };
        };

        // New helper to fetch global settings
        async function fetchGlobalSettings() {
            const { data, error } = await _supabase.from('global_settings').select('*');
            if (error) {
                console.error('Error fetching global settings:', error.message);
                return {};
            }
            // Transform array to a key-value object for easier access
            state.globalSettings = data.reduce((acc, setting) => {
                let value;
                switch (setting.data_type) {
                    case 'numeric':
                        value = parseFloat(setting.value);
                        break;
                    case 'boolean':
                        value = setting.value === 'true';
                        break;
                    case 'json':
                        try {
                            value = JSON.parse(setting.value);
                        } catch (e) {
                            console.error(`Error parsing JSON for setting ${setting.key_name}:`, e);
                            value = setting.value; // Fallback to raw string
                        }
                        break;
                    default:
                        value = setting.value;
                }
                acc[setting.key_name] = value;
                return acc;
            }, {});
            console.log('Global Settings Loaded:', state.globalSettings);
        }

        // --- Page Setup & Rendering ---
        function showPage(pageName) {
            // Unsubscribe from all existing channels before showing a new page
            if (channels.length > 0) {
                channels.forEach(channel => {
                    _supabase.removeChannel(channel);
                });
                channels = []; // Clear the array after removing channels
            }

            if (!pageTemplates[pageName]) return;
            appContainer.innerHTML = pageTemplates[pageName];
            state.currentPage = pageName;

            appContainer.querySelectorAll('[data-page]').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(el.dataset.page);
                })
            })

            // Only create icons after the page content has been injected
            lucide.createIcons();

            switch (pageName) {
                case 'login': setupLoginPage(); break;
                case 'signup': setupSignupPage(); break;
                case 'dashboard': setupDashboardPage(); break;
                case 'scheduler': setupSchedulerPage(); break;
                case 'userManagement': setupUserManagementPage(); break;
                case 'bonusRules': setupBonusRulesPage(); break;
                case 'bonusReview': setupBonusReviewPage(); break;
                case 'globalSettings': setupGlobalSettingsPage(); break;
                case 'ruleSetManagement': setupRuleSetManagementPage(); break;
                case 'userProfile': setupUserProfilePage(); break;
            }
        }

        function renderNav() {
            if (state.isLoggedIn && state.profile) {
                mainHeader.classList.remove('hidden');
                profileName.textContent = state.profile.full_name || 'User';

                navLinksContainer.innerHTML = `<button data-page="dashboard" class="clay-button px-4 py-2 text-sm">Dashboard</button><button data-page="scheduler" class="clay-button px-4 py-2 text-sm">Scheduler</button>`;

                let dropdownLinks = `<a href="#" data-page="userProfile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-primary-lavender rounded-lg">Profile</a>`;
                if (state.profile.role === 'admin') {
                    dropdownLinks += `<a href="#" data-page="userManagement" class="block px-4 py-2 text-sm text-gray-700 hover:bg-primary-lavender rounded-lg">User Management</a>
                                            <a href="#" data-page="bonusRules" class="block px-4 py-2 text-sm text-gray-700 hover:bg-primary-lavender rounded-lg">Bonus Rules</a>
                                            <a href="#" data-page="bonusReview" class="block px-4 py-2 text-sm text-gray-700 hover:bg-primary-lavender rounded-lg">Bonus Review</a>
                                            <a href="#" data-page="globalSettings" class="block px-4 py-2 text-sm text-gray-700 hover:bg-primary-lavender rounded-lg">Global Settings</a>
                                            <a href="#" data-page="ruleSetManagement" class="block px-4 py-2 text-sm text-gray-700 hover:bg-primary-lavender rounded-lg">Rule Sets</a>`;
                }
                dropdownLinks += `<a href="#" id="logout-button" class="block px-4 py-2 text-sm text-gray-700 hover:bg-primary-lavender rounded-lg">Logout</a>`;
                profileDropdown.innerHTML = dropdownLinks;

                profileDropdown.querySelector('#logout-button').addEventListener('click', (e) => { e.preventDefault(); handleLogout(false); });

                lucide.createIcons(); // Re-create icons in header/nav after content updates
            } else {
                mainHeader.classList.add('hidden');
            }
        }

        async function checkUserSession() {
            setLoading(true);
            await fetchGlobalSettings(); // Fetch global settings on session check/app load
            const { data: { session }, error } = await _supabase.auth.getSession();
            if (error) {
                console.error("Error getting session:", error.message);
                showAlert('Session Error', 'Could not retrieve session. Please log in again.', () => handleLogout(true));
                setLoading(false); // Ensure loader is hidden even on error
                return;
            }
            if (session) {
                state.currentUser = session.user;
                const { data: profile, error: profileError } = await _supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();

                if (profileError) {
                    console.error("Error fetching profile:", profileError.message);
                    showAlert('Profile Error', 'Could not load your profile. Please try logging in again.', () => handleLogout(true));
                } else if (profile) {
                    if (profile.status === 'approved') {
                        state.profile = profile;
                        state.isLoggedIn = true;
                        renderNav();
                        if (state.currentPage === 'login' || state.currentPage === 'signup') {
                            showPage('dashboard');
                        }
                    } else {
                        await _supabase.auth.signOut();
                        showAlert('Account Pending', 'Your account is still awaiting admin approval. You can login once approved.', () => handleLogout(true));
                    }
                }
            } else {
                handleLogout(true);
            }
            setLoading(false);
        }

        async function handleLogout(isInitial = false) {
            if (!isInitial) {
                const { error } = await _supabase.auth.signOut();
                if (error) {
                    showAlert('Logout Error', error.message);
                    return;
                }
            }
            state.isLoggedIn = false;
            state.currentUser = null;
            state.profile = null;
            state.currentPage = 'login';

            // Ensure channels are cleared on full logout
            if (channels.length > 0) {
                channels.forEach(channel => _supabase.removeChannel(channel));
                channels = [];
            }

            renderNav();
            showPage('login');
            setLoading(false);
        }

        // --- Page-Specific Initializers ---
        function setupLoginPage() {
            const loginForm = document.getElementById('login-form');
            if (!loginForm) return;

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const loginButton = e.target.querySelector('button[type="submit"]');

                loginButton.disabled = true; // Disable button 
                loginButton.textContent = 'Logging in...'; // Show loading text 

                const { error } = await _supabase.auth.signInWithPassword({ email, password });

                if (error) {
                    showAlert('Login Failed', error.message);
                    // No need for setLoading(false) here, checkUserSession will run
                    // and handle the final loading state change if it doesn't redirect.
                }
                // Re-enable in case the checkUserSession doesn't lead to a page change
                // or if there's a subsequent error within checkUserSession.
                loginButton.disabled = false;
                loginButton.textContent = 'Login';
            });
        }

        function setupSignupPage() {
            const signupForm = document.getElementById('signup-form');
            if (!signupForm) return;

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const full_name = document.getElementById('fullname').value;
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const signupButton = e.target.querySelector('button[type="submit"]');

                signupButton.disabled = true; // Disable button 
                signupButton.textContent = 'Creating Account...'; // Show loading text 

                const { data, error } = await _supabase.auth.signUp({
                    email,
                    password,
                    options: { data: { full_name } }
                });

                if (error) {
                    showAlert('Signup Failed', error.message);
                } else if (data.user) {
                    showAlert('Account Created', 'Thank you for signing up! Your account is now pending admin approval. You can login once approved.', () => {
                        showPage('login');
                    });
                }
                signupButton.disabled = false; // Re-enable
                signupButton.textContent = 'Create Account';
            });
        }

        function setupDashboardPage() {
            const container = document.getElementById('dashboard-container');
            if (state.profile.role === 'admin') {
                document.getElementById('dashboard-title').textContent = "Admin Dashboard";
                document.getElementById('dashboard-subtitle').textContent = "Platform-wide performance overview.";
                initializeAdminDashboard(container);
            } else {
                document.getElementById('dashboard-title').textContent = "Dashboard";
                document.getElementById('dashboard-subtitle').textContent = `Welcome back, ${state.profile.full_name}!`;
                initializeSellerDashboard(container);
            }
        }

        function setupSchedulerPage() {
            initializeScheduler();
        }

        async function setupUserProfilePage() {
            if (!state.profile) { showPage('login'); return; }

            document.getElementById('profile-gcash').value = state.profile.gcash_number || '';
            document.getElementById('profile-contact').value = state.profile.contact_number || '';
            document.getElementById('profile-emergency').value = state.profile.emergency_contact || '';

            document.getElementById('profile-info-form').addEventListener('submit', async e => {
                e.preventDefault();
                const saveInfoButton = e.target.querySelector('button[type="submit"]');
                saveInfoButton.disabled = true; // Disable button 
                saveInfoButton.textContent = 'Saving...'; // Show loading text 

                const updates = {
                    id: state.currentUser.id,
                    gcash_number: document.getElementById('profile-gcash').value,
                    contact_number: document.getElementById('profile-contact').value,
                    emergency_contact: document.getElementById('profile-emergency').value,
                    updated_at: new Date()
                };

                const { error } = await _supabase.from('profiles').upsert(updates);
                if (error) showAlert('Error', 'Failed to update profile: ' + error.message);
                else {
                    state.profile = { ...state.profile, ...updates };
                    showAlert('Success', 'Your information has been updated.');
                }
                saveInfoButton.disabled = false; // Re-enable
                saveInfoButton.textContent = 'Save Information';
            });

            document.getElementById('password-change-form').addEventListener('submit', async e => {
                e.preventDefault();
                const newPassword = document.getElementById('profile-new-password').value;
                const confirmPassword = document.getElementById('profile-confirm-password').value;
                const changePasswordButton = e.target.querySelector('button[type="submit"]');

                if (!newPassword || newPassword !== confirmPassword) {
                    showAlert('Error', 'Passwords do not match. Please try again.');
                    return;
                }
                if (newPassword.length < (state.globalSettings.min_password_length || 8)) { // Use global setting for min length 
                    showAlert('Error', `New password must be at least ${state.globalSettings.min_password_length || 8} characters long.`);
                    return;
                }

                changePasswordButton.disabled = true; // Disable button 
                changePasswordButton.textContent = 'Changing...'; // Show loading text 

                const { error } = await _supabase.auth.updateUser({ password: newPassword });
                if (error) showAlert('Error', 'Failed to change password: ' + error.message);
                else {
                    showAlert('Success', 'Your password has been changed successfully.');
                    e.target.reset();
                }
                changePasswordButton.disabled = false; // Re-enable
                changePasswordButton.textContent = 'Change Password';
            });
        }

        async function setupUserManagementPage() {
            if (state.profile.role !== 'admin') { showPage('login'); return; }
            document.getElementById('close-user-details-btn').addEventListener('click', () => {
                document.getElementById('user-details-modal').classList.add('hidden');
            });
            await renderUserList();

            const userChannel = _supabase.channel('public:profiles')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, payload => {
                    renderUserList();
                })
                .subscribe();
            channels.push(userChannel);
        }

        // --- Bonus-related Functions (moved up for scope) ---
        async function renderBonusRulesList() {
            const container = document.getElementById('bonus-rules-list');
            if (!container) return;

            // This still fetches from the old 'bonus_rules' table as per your current code.
            // According to the roadmap, this should eventually be refactored to use 'rule_sets' and 'rules'.
            //  The document states 'public.rules' (Replaces public.bonus_rules in its current form).
            const { data: rules, error } = await _supabase.from('bonus_rules').select('*').order('created_at', { ascending: false });

            if (error) {
                showAlert('Error', 'Could not fetch bonus rules: ' + error.message);
                return;
            }

            if (rules.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">No bonus rules created yet.</p>`;
                return;
            }

            container.innerHTML = rules.map(rule => `
                <div class="clay-card p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                           <h3 class="font-playfair text-2xl font-bold">${rule.name}</h3>
                           <p class="text-gray-600 text-sm mt-1">${rule.description}</p>
                        </div>
                        <button class="delete-rule-btn clay-button !p-2" data-ruleid="${rule.id}"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                        <div class="clay-inset p-3"><span class="block text-sm font-semibold text-gray-500 uppercase">Live Hours</span><span class="block text-xl font-bold">${rule.live_hours_target}</span></div>
                        <div class="clay-inset p-3"><span class="block text-sm font-semibold text-gray-500 uppercase">Branded</span><span class="block text-xl font-bold">${rule.branded_items_target}</span></div>
                        <div class="clay-inset p-3"><span class="block text-sm font-semibold text-gray-500 uppercase">Free Size</span><span class="block text-xl font-bold">${rule.free_size_target}</span></div>
                        <div class="clay-inset p-3"><span class="block text-sm font-semibold text-gray-500 uppercase">Bonus</span><span class="block text-xl font-bold">₱${rule.bonus_amount.toFixed(2)}</span></div>
                    </div>
                    <div class="text-xs text-gray-500 mt-4 text-center">Active: ${new Date(rule.effective_start_date).toLocaleDateString()} to ${rule.effective_end_date ? new Date(rule.effective_end_date).toLocaleDateString() : 'Indefinite'} | Evaluated ${rule.bonus_cadence.charAt(0).toUpperCase() + rule.bonus_cadence.slice(1)}</div>
                </div>
            `).join('');

            document.querySelectorAll('.delete-rule-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    state.ruleToDelete = e.currentTarget.dataset.ruleid; // Keep as string for UUIDs
                    document.getElementById('delete-confirm-message').textContent = 'Are you sure you want to delete this bonus rule? This action cannot be undone.';
                    document.getElementById('delete-confirmation-modal').classList.remove('hidden');
                    // Reset delete form's _deleteType to handle 'bonusRule' specific deletion
                    const deleteConfirmForm = document.getElementById('delete-confirm-form');
                    deleteConfirmForm._deleteType = 'bonusRule';
                });
            });
            lucide.createIcons();
        }

        async function renderBonusReviewList() {
            const container = document.getElementById('bonus-review-list');
            if (!container) return;

            // Fetch pending bonuses and explicitly define the join for the seller's profile
            // Changed join from `bonus_rules` to `rule_sets` and `rules` as per the new schema logic 
            const { data: bonuses, error } = await _supabase
                .from('seller_bonuses_achieved')
                .select(`
                    id,
                    achieved_date,
                    bonus_amount_awarded,
                    calculation_period_start,
                    calculation_period_end,
                    status,
                    admin_notes,
                    profiles:seller_id (full_name),
                    rules (rule_name),       -- Join to the 'rules' table
                    rule_sets (name)         -- Join to the 'rule_sets' table
                `)
                .eq('status', 'pending_review')
                .order('achieved_date', { ascending: true });

            if (error) {
                showAlert('Error', 'Could not fetch pending bonuses: ' + error.message);
                return;
            }

            if (bonuses.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">No pending bonuses to review.</p>`;
                return;
            }

            container.innerHTML = `
                <div class="clay-card overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Seller</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bonus Rule</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Achieved On</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${bonuses.map((bonus, index) => `
                                <tr class="${index % 2 !== 0 ? 'bg-[rgba(0,0,0,0.04)]' : ''}">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${bonus.profiles.full_name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${bonus.rules ? bonus.rules.rule_name : (bonus.rule_sets ? bonus.rule_sets.name : 'N/A')}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">₱${bonus.bonus_amount_awarded.toFixed(2)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(bonus.calculation_period_start).toLocaleDateString()} - ${new Date(bonus.calculation_period_end).toLocaleDateString()}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(bonus.achieved_date).toLocaleDateString()} ${new Date(bonus.achieved_date).toLocaleTimeString()}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button class="review-bonus-btn clay-button clay-button-primary px-3 py-1 text-sm" data-bonus='${JSON.stringify(bonus)}'>Review</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.querySelectorAll('.review-bonus-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const bonusData = JSON.parse(e.currentTarget.dataset.bonus);
                    showReviewModal(bonusData);
                });
            });
            lucide.createIcons();
        }

        async function setupBonusRulesPage() {
            if (state.profile.role !== 'admin') { showPage('login'); return; }

            const createRuleBtn = document.getElementById('create-new-rule-btn');
            const modal = document.getElementById('create-bonus-rule-modal');
            const form = document.getElementById('bonus-rule-form');
            const cancelBtn = document.getElementById('cancel-bonus-rule-btn');
            const passwordConfirmModal = document.getElementById('password-confirm-modal');
            const passwordConfirmForm = document.getElementById('password-confirm-form');
            const deletePasswordInput = document.getElementById('delete-password-input');
            const cancelPasswordConfirmBtn = document.getElementById('cancel-password-confirm-btn');

            // Flag to prevent multiple event listeners from being attached
            if (form._hasBonusRuleSubmitListener) {
                form.removeEventListener('submit', form._hasBonusRuleSubmitListener);
            }

            const handleSubmit = async (e) => {
                e.preventDefault();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true; // Disable button 
                submitBtn.textContent = 'Creating...'; // Show loading text 

                // This still inserts into the old 'bonus_rules' table as per your current code.
                // According to the roadmap, this should eventually be refactored to insert into 'rule_sets' and 'rules'.
                const newRule = {
                    name: document.getElementById('rule-name').value,
                    description: document.getElementById('rule-description').value,
                    effective_start_date: document.getElementById('effective-start-date').value, // 
                    effective_end_date: document.getElementById('effective-end-date').value || null, // 
                    live_hours_target: parseFloat(document.getElementById('rule-live-hours').value),
                    branded_items_target: parseInt(document.getElementById('rule-branded-items').value),
                    free_size_target: parseInt(document.getElementById('rule-free-size').value),
                    bonus_cadence: document.getElementById('rule-time-frame').value, // 
                    bonus_reset_day: document.getElementById('rule-reset-day').value || null, // 
                    bonus_amount: parseFloat(document.getElementById('rule-bonus-amount').value),
                    admin_id: state.currentUser.id,
                    is_active: true // 
                };
                const { error } = await _supabase.from('bonus_rules').insert(newRule);
                if (error) showAlert('Error', 'Failed to create rule: ' + error.message);
                else {
                    renderBonusRulesList();
                    modal.classList.add('hidden');
                    showAlert('Success', 'New bonus rule has been created.');
                }
                submitBtn.disabled = false; // Re-enable
                submitBtn.textContent = 'Create Rule';
            };

            form.addEventListener('submit', handleSubmit);
            form._hasBonusRuleSubmitListener = handleSubmit; // Store reference to the handler

            createRuleBtn.addEventListener('click', () => { form.reset(); modal.classList.remove('hidden'); });
            cancelBtn.addEventListener('click', () => { modal.classList.add('hidden'); });

            // Handle the password confirmation flow for deletion
            document.getElementById('delete-confirm-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                // Close the initial confirm modal (deleteConfirmationModal)
                document.getElementById('delete-confirmation-modal').classList.add('hidden');

                // Open the password confirmation modal
                passwordConfirmModal.classList.remove('hidden');
                deletePasswordInput.value = ''; // Clear previous password input
            });

            document.getElementById('cancel-delete-btn').addEventListener('click', () => {
                document.getElementById('delete-confirmation-modal').classList.add('hidden');
            });

            // New listeners for the password confirmation modal
            cancelPasswordConfirmBtn.addEventListener('click', () => {
                passwordConfirmModal.classList.add('hidden');
                document.getElementById('delete-confirmation-modal').classList.add('hidden'); // Also close the first confirm modal
            });

            // The password confirmation form's submit listener
            if (passwordConfirmForm._hasPasswordConfirmSubmitListener) {
                passwordConfirmForm.removeEventListener('submit', passwordConfirmForm._hasPasswordConfirmSubmitListener);
            }
            const handlePasswordConfirmSubmit = async (e) => {
                e.preventDefault();
                const password = deletePasswordInput.value;
                const confirmDeleteBtn = e.target.querySelector('button[type="submit"]');

                if (!password) {
                    showAlert('Error', 'Please enter your password.');
                    return;
                }

                confirmDeleteBtn.disabled = true; // Disable button 
                confirmDeleteBtn.textContent = 'Verifying...'; // Show loading text 

                // Re-authenticate the user
                const { error: authError } = await _supabase.auth.signInWithPassword({
                    email: state.currentUser.email,
                    password: password,
                });

                if (authError) {
                    showAlert('Authentication Failed', 'Incorrect password. Please try again.');
                    deletePasswordInput.value = ''; // Clear password field
                    confirmDeleteBtn.disabled = false; // Re-enable
                    confirmDeleteBtn.textContent = 'Confirm Delete';
                    return;
                }

                // Determine what to delete based on the stored type
                const deleteType = document.getElementById('delete-confirm-form')._deleteType;
                let deleteError;

                if (deleteType === 'ruleset') {
                    // This section handles deleting a rule set from ruleSetManagementPage
                    const { error: rsDeleteError } = await _supabase.from('rule_sets').delete().eq('id', state.ruleToDelete);
                    deleteError = rsDeleteError;
                } else { // Default to bonusRule deletion if no specific type is set or it's 'bonusRule'
                    // This handles deleting a rule from bonusRulesPage (old system)
                    const { error: brDeleteError } = await _supabase.from('bonus_rules').delete().eq('id', state.ruleToDelete);
                    deleteError = brDeleteError;
                }

                if (deleteError) {
                    showAlert('Error', 'Failed to delete: ' + deleteError.message);
                } else {
                    if (deleteType === 'ruleset') {
                        renderRuleSetsList();
                        showAlert('Success', 'Rule set and associated rules deleted.');
                    } else {
                        renderBonusRulesList();
                        showAlert('Success', 'Bonus rule has been deleted.');
                    }
                }
                state.ruleToDelete = null; // Clear the state
                passwordConfirmModal.classList.add('hidden'); // Close password modal
                document.getElementById('delete-confirmation-modal').classList.add('hidden'); // Close initial confirm modal if still open
                confirmDeleteBtn.disabled = false; // Re-enable
                confirmDeleteBtn.textContent = 'Confirm Delete';
            };
            passwordConfirmForm.addEventListener('submit', handlePasswordConfirmSubmit);
            passwordConfirmForm._hasPasswordConfirmSubmitListener = handlePasswordConfirmSubmit; // Store ref for removal

            await renderBonusRulesList();
        }

        async function setupBonusReviewPage() {
            if (state.profile.role !== 'admin') { showPage('login'); return; }

            const reviewModal = document.getElementById('review-bonus-modal');
            const reviewBonusTitle = document.getElementById('review-bonus-title');
            const reviewBonusDetails = document.getElementById('review-bonus-details');
            const reviewBonusNotesInput = document.getElementById('review-bonus-notes');
            const approveBonusBtn = document.getElementById('approve-bonus-action-btn');
            const rejectBonusBtn = document.getElementById('reject-bonus-action-btn');
            const cancelReviewBtn = document.getElementById('cancel-review-bonus-btn');

            let bonusToReview = null; // Store the current bonus being reviewed

            const showReviewModal = (bonus) => {
                bonusToReview = bonus;
                reviewBonusTitle.textContent = `Review Bonus for ${bonus.profiles.full_name}`;
                reviewBonusDetails.innerHTML = `
                    <p><strong>Rule:</strong> ${bonus.rules ? bonus.rules.rule_name : (bonus.rule_sets ? bonus.rule_sets.name : 'N/A')}</p>
                    <p><strong>Amount:</strong> ₱${bonus.bonus_amount_awarded.toFixed(2)}</p>
                    <p><strong>Period:</strong> ${new Date(bonus.calculation_period_start).toLocaleDateString()} - ${new Date(bonus.calculation_period_end).toLocaleDateString()}</p>
                    <p><strong>Achieved On:</strong> ${new Date(bonus.achieved_date).toLocaleDateString()} ${new Date(bonus.achieved_date).toLocaleTimeString()}</p>
                `;
                reviewBonusNotesInput.value = bonus.admin_notes || '';
                reviewModal.classList.remove('hidden');
            };

            const handleReviewAction = async (actionType) => {
                const notes = reviewBonusNotesInput.value.trim();
                if (actionType === 'reject' && !notes) {
                    showAlert('Validation Error', 'Admin notes are required for rejecting a bonus.');
                    return;
                }

                const button = actionType === 'approve' ? approveBonusBtn : rejectBonusBtn;
                button.disabled = true; // Disable button 
                button.textContent = actionType === 'approve' ? 'Approving...' : 'Rejecting...'; // Show loading text 

                try {
                    if (actionType === 'approve') {
                        const { error } = await _supabase.rpc('approve_seller_bonus', { p_bonus_id: bonusToReview.id, p_admin_notes: notes || null });
                        if (error) throw error;
                        showAlert('Success', 'Bonus approved successfully.');
                    } else { // reject
                        const { error } = await _supabase.rpc('reject_seller_bonus', { p_bonus_id: bonusToReview.id, p_admin_notes: notes }); // 
                        if (error) throw error;
                        showAlert('Success', 'Bonus rejected successfully.');
                    }
                    reviewModal.classList.add('hidden');
                    renderBonusReviewList(); // Re-render the list after action
                } catch (error) {
                    showAlert('Error', `Failed to ${actionType} bonus: ${error.message}`);
                } finally {
                    button.disabled = false; // Re-enable
                    button.textContent = actionType === 'approve' ? 'Approve Bonus' : 'Reject Bonus';
                }
            };

            approveBonusBtn.addEventListener('click', (e) => { e.preventDefault(); handleReviewAction('approve'); });
            rejectBonusBtn.addEventListener('click', (e) => { e.preventDefault(); handleReviewAction('reject'); });
            cancelReviewBtn.addEventListener('click', () => { reviewModal.classList.add('hidden'); });

            await renderBonusReviewList();

            // Real-time listener for seller_bonuses_achieved
            const bonusReviewChannel = _supabase.channel('public:seller_bonuses_achieved')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'seller_bonuses_achieved' }, payload => {
                    renderBonusReviewList();
                })
                .subscribe();
            channels.push(bonusReviewChannel);
        }

        async function showUserDetailsModal(userId) {
            const { data: user, error } = await _supabase.from('profiles').select('*').eq('id', userId).single();
            if (error || !user) return showAlert('Error', 'Could not fetch user details.');

            document.getElementById('user-details-name').textContent = user.full_name;
            document.getElementById('user-details-gcash').textContent = user.gcash_number || 'Not set';
            document.getElementById('user-details-contact').textContent = user.contact_number || 'Not set';
            document.getElementById('user-details-emergency').textContent = user.emergency_contact || 'Not set';
            document.getElementById('user-details-modal').classList.remove('hidden');
        }

        async function renderUserList() {
            const container = document.getElementById('user-list-container');
            if (!container) return;

            const { data: users, error } = await _supabase.from('profiles').select('*').neq('role', 'admin').order('full_name');
            if (error) return showAlert('Error', 'Failed to fetch users: ' + error.message);

            if (users.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">No users found.</p>`;
                return;
            }

            container.innerHTML = `<div>${users.map((user, index) => `
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4 p-4 ${index % 2 !== 0 ? 'bg-[rgba(0,0,0,0.04)]' : ''}">
                    <div class="text-center sm:text-left flex-grow cursor-pointer view-user-details" data-userid="${user.id}">
                        <p class="font-bold">${user.full_name}</p>
                        <p class="text-sm text-gray-600">${user.email}</p>
                    </div>
                    <div class="flex items-center gap-2 mt-2 sm:mt-0">
                        ${user.status === 'pending' ?
                            `<button data-userid="${user.id}" class="approve-user-btn clay-button clay-button-approve px-3 py-2 text-sm">Approve</button>` :
                            `<span class="text-sm font-bold text-green-700 px-3 py-2">Approved</span>`
                        }
                    </div>
                </div>
            `).join('')}</div>`;

            document.querySelectorAll('.view-user-details').forEach(el => el.addEventListener('click', (e) => showUserDetailsModal(e.currentTarget.dataset.userid)));
            document.querySelectorAll('.approve-user-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    e.currentTarget.disabled = true; // Disable button 
                    e.currentTarget.textContent = 'Approving...'; // Show loading 
                    const userId = e.target.closest('[data-userid]').dataset.userid;
                    const { error } = await _supabase.from('profiles').update({ status: 'approved' }).eq('id', userId);
                    if (error) showAlert('Error', 'Failed to approve user: ' + error.message);
                    else showAlert('Success', 'User has been approved.');
                    e.currentTarget.disabled = false; // Re-enable
                    e.currentTarget.textContent = 'Approve';
                });
            });
        }

        // --- Global Settings Management ---
        async function setupGlobalSettingsPage() {
            if (state.profile.role !== 'admin') { showPage('login'); return; }
            await renderGlobalSettings();

            // Real-time listener for global_settings changes
            const settingsChannel = _supabase.channel('public:global_settings')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'global_settings' }, payload => {
                    fetchGlobalSettings(); // Re-fetch to update cached settings
                    renderGlobalSettings(); // Re-render the display
                })
                .subscribe();
            channels.push(settingsChannel);
        }

        async function renderGlobalSettings() {
            const container = document.getElementById('settings-list');
            if (!container) return;

            const { data: settings, error } = await _supabase.from('global_settings').select('*').order('key_name');
            if (error) {
                showAlert('Error', 'Could not fetch global settings: ' + error.message);
                return;
            }

            if (settings.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">No global settings defined yet.</p>`;
                return;
            }

            container.innerHTML = settings.map(setting => `
                <div class="clay-card p-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div class="flex-grow">
                        <h3 class="font-playfair text-xl font-bold">${setting.key_name.replace(/_/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}</h3>
                        <p class="text-gray-600 text-sm mt-1">${setting.description || 'No description provided.'}</p>
                        <p class="text-xs text-gray-500 mt-2">Type: ${setting.data_type} | Editable: ${setting.admin_editable ? 'Yes' : 'No'}</p>
                    </div>
                    <div class="flex items-center gap-3 w-full sm:w-auto mt-3 sm:mt-0">
                        <span id="setting-value-${setting.key_name}" class="font-bold text-lg">${setting.data_type === 'numeric' ? parseFloat(setting.value).toLocaleString() : setting.value}</span>
                        ${setting.admin_editable ? `<button class="edit-setting-btn clay-button !p-2" data-key="${setting.key_name}" data-value="${setting.value}" data-type="${setting.data_type}"><i data-lucide="pencil" class="h-4 w-4"></i></button>` : ''}
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.edit-setting-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const key = e.currentTarget.dataset.key;
                    const currentValue = e.currentTarget.dataset.value;
                    const dataType = e.currentTarget.dataset.type;

                    let newValue;
                    // Use a more appropriate input method based on data_type
                    if (dataType === 'boolean') {
                        const currentBool = currentValue === 'true';
                        // Using confirm for boolean toggle
                        newValue = confirm(`Toggle "${key.replace(/_/g, ' ')}"? Current: ${currentBool ? 'TRUE' : 'FALSE'}`) ? (!currentBool).toString() : null;
                    } else {
                        // Prompt for other types, pre-filling with current value
                        newValue = prompt(`Edit "${key.replace(/_/g, ' ')}"\n(Current: ${currentValue}, Type: ${dataType}):`, currentValue);
                    }

                    if (newValue !== null) { // User clicked OK or confirmed
                        e.currentTarget.disabled = true; // Disable button during async operation 
                        e.currentTarget.innerHTML = '<div class="spinner h-4 w-4"></div>'; // Simple spinner 
                        await updateGlobalSetting(key, newValue, dataType);
                        e.currentTarget.disabled = false; // Re-enable
                        e.currentTarget.innerHTML = '<i data-lucide="pencil" class="h-4 w-4"></i>'; // Restore icon
                        lucide.createIcons(); // Re-create icon if needed
                    }
                });
            });
            lucide.createIcons();
        }

        async function updateGlobalSetting(key_name, new_value, data_type) {
            let parsed_value = new_value;
            // Basic client-side validation and type casting
            if (data_type === 'numeric') {
                parsed_value = parseFloat(new_value);
                if (isNaN(parsed_value)) {
                    showAlert('Invalid Input', 'Please enter a valid number.');
                    return;
                }
                parsed_value = parsed_value.toString(); // Store back as string
            } else if (data_type === 'boolean') {
                parsed_value = (new_value.toLowerCase() === 'true' || new_value.toLowerCase() === '1').toString();
            } else if (data_type === 'json') {
                try {
                    JSON.parse(new_value);
                    parsed_value = new_value;
                } catch (e) {
                    showAlert('Invalid Input', 'Please enter valid JSON.');
                    return;
                }
            }

            const { error } = await _supabase.from('global_settings')
                .update({ value: parsed_value, last_updated_by: state.currentUser.id, updated_at: new Date() })
                .eq('key_name', key_name);

            if (error) {
                showAlert('Error', 'Failed to update setting: ' + error.message);
            } else {
                showAlert('Success', `Setting "${key_name}" updated.`);
            }
        }


        // --- Rule Set Management ---
        async function setupRuleSetManagementPage() {
            if (state.profile.role !== 'admin') { showPage('login'); return; }

            const createRuleSetBtn = document.getElementById('create-new-ruleset-btn');
            const createRuleSetModal = document.getElementById('create-ruleset-modal');
            const ruleSetForm = document.getElementById('ruleset-form');
            const cancelRuleSetBtn = document.getElementById('cancel-ruleset-btn');
            const ruleSetTypeSelect = document.getElementById('ruleset-type');

            const viewRuleSetDetailsModal = document.getElementById('view-ruleset-details-modal');
            const addRuleToRuleSetBtn = document.getElementById('add-rule-to-ruleset-btn');
            const toggleRulesetActiveBtn = document.getElementById('toggle-ruleset-active-btn');
            const deleteRulesetBtn = document.getElementById('delete-ruleset-btn');
            const closeRuleSetDetailsBtn = document.getElementById('close-ruleset-details-btn');
            const editRuleModal = document.getElementById('edit-rule-modal');
            const editRuleForm = document.getElementById('edit-rule-form');
            const cancelEditRuleBtn = document.getElementById('cancel-edit-rule-btn');


            // Populate Rule Types dropdown
            const { data: ruleTypes, error: rtError } = await _supabase.from('rule_types').select('id, name');
            if (rtError) { console.error('Error fetching rule types:', rtError.message); showAlert('Error', 'Could not fetch rule types.'); }
            else {
                ruleSetTypeSelect.innerHTML = ruleTypes.map(type => `<option value="${type.id}">${type.name}</option>`).join('');
            }

            createRuleSetBtn.addEventListener('click', () => { ruleSetForm.reset(); createRuleSetModal.classList.remove('hidden'); });
            cancelRuleSetBtn.addEventListener('click', () => { createRuleSetModal.classList.add('hidden'); });

            closeRuleSetDetailsBtn.addEventListener('click', () => { viewRuleSetDetailsModal.classList.add('hidden'); state.currentRuleSetId = null; });
            cancelEditRuleBtn.addEventListener('click', () => { editRuleModal.classList.add('hidden'); });


            // Event listener for creating a new rule set
            if (ruleSetForm._hasRuleSetSubmitListener) {
                ruleSetForm.removeEventListener('submit', ruleSetForm._hasRuleSetSubmitListener);
            }
            const handleRuleSetSubmit = async (e) => {
                e.preventDefault();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true; // Disable button 
                submitBtn.textContent = 'Creating...'; // Show loading text 

                const newRuleSet = {
                    name: document.getElementById('ruleset-name').value,
                    description: document.getElementById('ruleset-description').value,
                    rule_type_id: parseInt(document.getElementById('ruleset-type').value),
                    effective_start_date: document.getElementById('ruleset-start-date').value,
                    effective_end_date: document.getElementById('ruleset-end-date').value || null,
                    created_by: state.currentUser.id,
                    is_active: false // New rule sets are inactive by default
                };

                const { error } = await _supabase.from('rule_sets').insert(newRuleSet);
                if (error) showAlert('Error', 'Failed to create rule set: ' + error.message);
                else {
                    showAlert('Success', 'New rule set created. It is currently inactive.');
                    createRuleSetModal.classList.add('hidden');
                    renderRuleSetsList();
                }
                submitBtn.disabled = false; // Re-enable
                submitBtn.textContent = 'Create Rule Set';
            };
            ruleSetForm.addEventListener('submit', handleRuleSetSubmit);
            ruleSetForm._hasRuleSetSubmitListener = handleRuleSetSubmit;


            // Event listener for adding/editing a rule within a rule set
            if (editRuleForm._hasEditRuleSubmitListener) {
                editRuleForm.removeEventListener('submit', editRuleForm._hasEditRuleSubmitListener);
            }
            const handleEditRuleSubmit = async (e) => {
                e.preventDefault();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true; // Disable button 
                submitBtn.textContent = 'Saving...'; // Show loading text 

                const ruleId = editRuleForm.dataset.ruleId;
                const ruleSetId = state.currentRuleSetId; // From state

                const ruleData = {
                    rule_name: document.getElementById('edit-rule-name').value,
                    criteria_field: document.getElementById('edit-criteria-field').value, // 
                    operator: document.getElementById('edit-operator').value, // 
                    target_value: parseFloat(document.getElementById('edit-target-value').value), // 
                    payout_type: document.getElementById('edit-payout-type').value, // 
                    payout_value: parseFloat(document.getElementById('edit-payout-value').value), // 
                    cadence: document.getElementById('edit-cadence').value || null, // 
                    priority: parseInt(document.getElementById('edit-priority').value) || null, // 
                };

                let error;
                if (ruleId === 'new') { // Add new rule
                    const { error: insertError } = await _supabase.from('rules').insert({ ...ruleData, rule_set_id: ruleSetId });
                    error = insertError;
                } else { // Update existing rule
                    const { error: updateError } = await _supabase.from('rules').update(ruleData).eq('id', ruleId);
                    error = updateError;
                }

                if (error) showAlert('Error', 'Failed to save rule: ' + error.message);
                else {
                    showAlert('Success', 'Rule saved successfully.');
                    editRuleModal.classList.add('hidden');
                    showRuleSetDetailsModal(ruleSetId); // Re-render details after save
                }
                submitBtn.disabled = false; // Re-enable
                submitBtn.textContent = 'Save Rule';
            };
            editRuleForm.addEventListener('submit', handleEditRuleSubmit);
            editRuleForm._hasEditRuleSubmitListener = handleEditRuleSubmit;


            addRuleToRuleSetBtn.addEventListener('click', () => {
                editRuleForm.reset();
                editRuleForm.dataset.ruleId = 'new'; // Indicate a new rule
                document.getElementById('edit-rule-name').value = ''; // Clear default if any
                editRuleModal.classList.remove('hidden');
            });

            // Toggle active status for Rule Set
            toggleRulesetActiveBtn.addEventListener('click', async (e) => {
                const button = e.currentTarget;
                button.disabled = true; // Disable button 
                button.textContent = 'Updating...'; // Show loading 
                const ruleSetId = state.currentRuleSetId;
                const currentStatus = (button.dataset.isactive === 'true');
                const newStatus = !currentStatus;

                const { error } = await _supabase.from('rule_sets').update({ is_active: newStatus }).eq('id', ruleSetId);
                if (error) showAlert('Error', 'Failed to toggle rule set status: ' + error.message);
                else {
                    showAlert('Success', `Rule set ${newStatus ? 'activated' : 'deactivated'}.`);
                    // Update the button's data-isactive and text
                    button.dataset.isactive = newStatus;
                    button.textContent = newStatus ? 'Deactivate' : 'Activate';
                    button.classList.toggle('clay-button-deny', newStatus);
                    button.classList.toggle('clay-button-approve', !newStatus);
                    renderRuleSetsList(); // Re-render the main list to update status there too
                }
                button.disabled = false; // Re-enable
            });

            // Delete Rule Set
            deleteRulesetBtn.addEventListener('click', async (e) => {
                state.ruleToDelete = state.currentRuleSetId;
                document.getElementById('delete-confirm-message').textContent = 'Are you sure you want to delete this rule set and all its associated rules? This action cannot be undone.';
                document.getElementById('delete-confirmation-modal').classList.remove('hidden');
                const deleteConfirmForm = document.getElementById('delete-confirm-form');
                deleteConfirmForm._deleteType = 'ruleset'; // Custom property to differentiate
            });


            await renderRuleSetsList();

            // Real-time listener for rule_sets and rules
            const ruleSetsChannel = _supabase.channel('public:rule_sets')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'rule_sets' }, payload => {
                    renderRuleSetsList();
                    if (state.currentRuleSetId && payload.new && payload.new.id === state.currentRuleSetId) {
                        showRuleSetDetailsModal(state.currentRuleSetId); // Re-render if current rule set changed
                    }
                })
                .subscribe();
            channels.push(ruleSetsChannel);

            const rulesChannel = _supabase.channel('public:rules')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'rules' }, payload => {
                    if (state.currentRuleSetId && (payload.new && payload.new.rule_set_id === state.currentRuleSetId || payload.old && payload.old.rule_set_id === state.currentRuleSetId)) {
                        showRuleSetDetailsModal(state.currentRuleSetId); // Re-render if rules in current rule set changed
                    }
                })
                .subscribe();
            channels.push(rulesChannel);
        }

        async function renderRuleSetsList() {
            const container = document.getElementById('rulesets-list');
            if (!container) return;

            const { data: ruleSets, error } = await _supabase
                .from('rule_sets')
                .select(`
                    id,
                    name,
                    description,
                    is_active,
                    effective_start_date,
                    effective_end_date,
                    rule_types(name)
                `)
                .order('created_at', { ascending: false });

            if (error) {
                showAlert('Error', 'Could not fetch rule sets: ' + error.message);
                return;
            }

            if (ruleSets.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">No rule sets defined yet.</p>`;
                return;
            }

            container.innerHTML = ruleSets.map(set => `
                <div class="clay-card p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-playfair text-2xl font-bold">${set.name}</h3>
                            <p class="text-gray-600 text-sm mt-1">${set.description || 'No description.'}</p>
                            <p class="text-xs text-gray-500 mt-2">
                                Type: ${set.rule_types.name} | Status: <span class="font-semibold ${set.is_active ? 'text-primary-mint' : 'text-action-red'}">${set.is_active ? 'Active' : 'Inactive'}</span>
                                <br>Effective: ${new Date(set.effective_start_date).toLocaleDateString()} to ${set.effective_end_date ? new Date(set.effective_end_date).toLocaleDateString() : 'Indefinite'}
                            </p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button class="view-ruleset-btn clay-button !p-2" data-rulesetid="${set.id}"><i data-lucide="eye" class="h-4 w-4"></i> View</button>
                            ${set.is_active ? `<button class="toggle-ruleset-active-btn clay-button clay-button-deny !p-2" data-rulesetid="${set.id}" data-isactive="true"><i data-lucide="toggle-right" class="h-4 w-4"></i> Deactivate</button>` : `<button class="toggle-ruleset-active-btn clay-button clay-button-approve !p-2" data-rulesetid="${set.id}" data-isactive="false"><i data-lucide="toggle-left" class="h-4 w-4"></i> Activate</button>`}
                            <button class="delete-ruleset-btn clay-button !p-2" data-rulesetid="${set.id}"><i data-lucide="trash-2" class="h-4 w-4"></i> Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.view-ruleset-btn').forEach(button => {
                button.addEventListener('click', (e) => showRuleSetDetailsModal(e.currentTarget.dataset.rulesetid)); // Pass UUID as string
            });

            document.querySelectorAll('.toggle-ruleset-active-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const ruleSetId = e.currentTarget.dataset.rulesetid; // Keep as string for UUIDs
                    const isActive = e.currentTarget.dataset.isactive === 'true'; // Current active state
                    const newStatus = !isActive;

                    e.currentTarget.disabled = true; // Disable button 
                    e.currentTarget.textContent = 'Updating...'; // Show loading 

                    const { error } = await _supabase.from('rule_sets').update({ is_active: newStatus }).eq('id', ruleSetId);
                    if (error) showAlert('Error', 'Failed to toggle rule set status: ' + error.message);
                    else {
                        showAlert('Success', `Rule set ${newStatus ? 'activated' : 'deactivated'}.`);
                        renderRuleSetsList(); // Re-render to update status
                    }
                    e.currentTarget.disabled = false; // Re-enable
                    e.currentTarget.textContent = newStatus ? 'Deactivate' : 'Activate'; // Update button text
                });
            });

            document.querySelectorAll('.delete-ruleset-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    state.ruleToDelete = e.currentTarget.dataset.rulesetid; // Reuse ruleToDelete state, keep as string for UUIDs
                    document.getElementById('delete-confirm-message').textContent = 'Are you sure you want to delete this rule set and all its associated rules? This action cannot be undone.';
                    document.getElementById('delete-confirmation-modal').classList.remove('hidden');
                    // Update the delete confirm form's submission to handle rule set deletion
                    const deleteConfirmForm = document.getElementById('delete-confirm-form');
                    deleteConfirmForm._deleteType = 'ruleset'; // Custom property to differentiate
                });
            });

            lucide.createIcons();
        }

        async function showRuleSetDetailsModal(ruleSetId) {
            state.currentRuleSetId = ruleSetId; // Store current rule set ID in state

            const { data: ruleSet, error: ruleSetError } = await _supabase
                .from('rule_sets')
                .select(`*, rule_types(name)`)
                .eq('id', ruleSetId)
                .single();
            if (ruleSetError) { showAlert('Error', 'Could not fetch rule set details: ' + ruleSetError.message); return; }

            const { data: rulesInSet, error: rulesError } = await _supabase
                .from('rules')
                .select('*')
                .eq('rule_set_id', ruleSetId)
                .order('priority', { ascending: true });
            if (rulesError) { showAlert('Error', 'Could not fetch rules for this set: ' + rulesError.message); return; }

            document.getElementById('view-ruleset-name').textContent = ruleSet.name;
            document.getElementById('view-ruleset-description').textContent = ruleSet.description || 'No description provided.';
            document.getElementById('view-ruleset-status').textContent = `Type: ${ruleSet.rule_types.name} | Status: ${ruleSet.is_active ? 'Active' : 'Inactive'}`;
            document.getElementById('view-ruleset-dates').textContent = `Effective: ${new Date(ruleSet.effective_start_date).toLocaleDateString()} to ${ruleSet.effective_end_date ? new Date(ruleSet.effective_end_date).toLocaleDateString() : 'Indefinite'}`;

            // Update the toggle button based on ruleSet.is_active
            const toggleRulesetActiveBtn = document.getElementById('toggle-ruleset-active-btn');
            toggleRulesetActiveBtn.dataset.isactive = ruleSet.is_active;
            toggleRulesetActiveBtn.textContent = ruleSet.is_active ? 'Deactivate' : 'Activate';
            toggleRulesetActiveBtn.classList.toggle('clay-button-deny', ruleSet.is_active);
            toggleRulesetActiveBtn.classList.toggle('clay-button-approve', !ruleSet.is_active);


            const rulesListContainer = document.getElementById('rules-in-set-list');
            rulesListContainer.innerHTML = ''; // Clear previous rules

            if (rulesInSet.length === 0) {
                rulesListContainer.innerHTML = `<p class="text-center text-gray-500">No rules defined in this set yet.</p>`;
            } else {
                rulesInSet.forEach(rule => {
                    const ruleDiv = document.createElement('div');
                    ruleDiv.className = 'clay-card p-4 flex justify-between items-center';
                    ruleDiv.innerHTML = `
                        <div>
                            <p class="font-semibold">${rule.rule_name}</p>
                            <p class="text-sm text-gray-600">${rule.criteria_field.replace(/_/g, ' ').toUpperCase()} ${rule.operator} ${rule.target_value} -> ${rule.payout_type.replace(/_/g, ' ').toUpperCase()}: ${state.globalSettings.default_currency_symbol || '₱'}${rule.payout_value} ${rule.payout_type === 'percentage' ? '%' : ''}</p>
                            <p class="text-xs text-gray-500">Cadence: ${rule.cadence || 'N/A'} | Priority: ${rule.priority || 'N/A'}</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="edit-rule-btn clay-button !p-2" data-rule='${JSON.stringify(rule)}'><i data-lucide="pencil" class="h-4 w-4"></i> Edit</button>
                            <button class="delete-individual-rule-btn clay-button !p-2" data-ruleid="${rule.id}"><i data-lucide="trash-2" class="h-4 w-4"></i> Delete</button>
                        </div>
                    `;
                    rulesListContainer.appendChild(ruleDiv);
                });

                document.querySelectorAll('.edit-rule-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const ruleData = JSON.parse(e.currentTarget.dataset.rule);
                        editRuleForm.dataset.ruleId = ruleData.id; // Store rule ID for update
                        document.getElementById('edit-rule-name').value = ruleData.rule_name;
                        document.getElementById('edit-criteria-field').value = ruleData.criteria_field;
                        document.getElementById('edit-operator').value = ruleData.operator;
                        document.getElementById('edit-target-value').value = ruleData.target_value;
                        document.getElementById('edit-payout-type').value = ruleData.payout_type;
                        document.getElementById('edit-payout-value').value = ruleData.payout_value;
                        document.getElementById('edit-cadence').value = ruleData.cadence || '';
                        document.getElementById('edit-priority').value = ruleData.priority || '';
                        editRuleModal.classList.remove('hidden');
                    });
                });

                document.querySelectorAll('.delete-individual-rule-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const ruleId = e.currentTarget.dataset.ruleid; // Keep as string for UUIDs
                        const confirmDelete = confirm('Are you sure you want to delete this rule?');
                        if (confirmDelete) {
                            e.currentTarget.disabled = true; // Disable button 
                            e.currentTarget.innerHTML = '<div class="spinner h-4 w-4"></div>'; // Show loading 
                            const { error } = await _supabase.from('rules').delete().eq('id', ruleId);
                            if (error) showAlert('Error', 'Failed to delete rule: ' + error.message);
                            else {
                                showAlert('Success', 'Rule deleted successfully.');
                                showRuleSetDetailsModal(state.currentRuleSetId); // Re-render
                            }
                            e.currentTarget.disabled = false; // Re-enable (though modal closes typically)
                        }
                    });
                });
            }

            viewRuleSetDetailsModal.classList.remove('hidden');
            lucide.createIcons();
        }


        // --- Dashboard Module (Full Implementation) ---
        function initializeAdminDashboard(container) {
            container.innerHTML = `<div class="clay-card p-4 mb-8"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end"><div><label for="seller-filter" class="block text-sm font-medium mb-1">Filter by Seller</label><select id="seller-filter" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none"></select></div><div><label for="date-filter" class="block text-sm font-medium mb-1">Filter by Date Range</label><select id="date-filter" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none"><option>All Time</option><option>This Week</option><option>Last Week</option><option>This Month</option><option>Custom</option></select></div></div><div id="custom-date-filters" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4"><div><label for="start-date" class="block text-sm font-medium mb-1">Start Date</label><input type="date" id="start-date" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none"></div><div><label for="end-date" class="block text-sm font-medium mb-1">End Date</label><input type="date" id="end-date" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none"></div></div></div>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
                <div class="md:col-span-2 clay-card p-6 flex flex-col justify-center"><div class="flex items-center justify-between text-gray-600 mb-2"><h3 id="final-pay-label" class="text-lg font-semibold uppercase tracking-wider"></h3><i data-lucide="wallet" class="text-gray-500"></i></div><p id="final-pay" class="font-playfair text-6xl font-bold" style="color: #831843;">₱0.00</p></div>
                <div class="md:col-span-3 grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div class="clay-card p-4 flex flex-col justify-center text-center"><h3 id="live-duration-label" class="text-sm font-semibold uppercase tracking-wider text-gray-600"></h3><p id="live-duration" class="font-playfair text-3xl font-bold text-gray-800 mt-2">0.0 <span class="text-xl align-baseline">hrs</span></p></div>
                    <div class="clay-card p-4 flex flex-col justify-center text-center"><h3 id="base-pay-label" class="text-sm font-semibold uppercase tracking-wider text-gray-600"></h3><p id="base-pay" class="font-playfair text-3xl font-bold text-gray-800 mt-2">₱0.00</p></div>
                    <div class="clay-card p-4 flex flex-col justify-center text-center"><h3 id="branded-sold-label" class="text-sm font-semibold uppercase tracking-wider text-gray-600"></h3><p id="branded-sold" class="font-playfair text-3xl font-bold mt-2 text-gray-800">0</p></div>
                    <div class="clay-card p-4 flex flex-col justify-center text-center"><h3 id="free-size-sold-label" class="text-sm font-semibold uppercase tracking-wider text-gray-600"></h3><p id="free-size-sold" class="font-playfair text-3xl font-bold mt-2 text-gray-800">0</p></div>
                </div>
            </div>
            <div class="clay-card p-6 mb-8"><h3 class="font-playfair text-2xl font-bold mb-4">Running Incentives</h3><div id="bonus-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div></div>
            <div class="clay-card overflow-hidden"><h2 id="logged-entries-title" class="text-xl p-6 font-bold font-playfair border-b-2 border-dashed border-lavender-300"></h2><div id="table-container" class="overflow-x-auto"><table class="w-full table-auto"><thead class="text-gray-600"><tr></tr></thead><tbody id="table-body"></tbody></table></div><div id="no-entries" class="text-center p-8 text-gray-500 hidden">No entries found.</div><div id="pagination-controls" class="p-4 flex items-center justify-between flex-wrap gap-2"><span id="page-info" class="text-sm"></span><div class="flex items-center gap-2"><button id="prev-page" class="clay-button p-2 disabled:opacity-50"><i data-lucide="chevron-left"></i></button><button id="next-page" class="clay-button p-2 disabled:opacity-50"><i data-lucide="chevron-right"></i></button></div></div></div>`;
            runDashboardLogic('admin');
        }

        function initializeSellerDashboard(container) {
            container.innerHTML = `
                <div class="clay-card p-4 mb-8"><div class="flex flex-col sm:flex-row items-center justify-between gap-4"><div class="flex-grow flex flex-wrap items-end gap-4"><div><label for="date-filter" class="block text-sm font-medium mb-1">Date Range</label><select id="date-filter" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none"><option>All Time</option><option>This Week</option><option>Last Week</option><option>This Month</option><option>Custom</option></select></div><div id="custom-date-filters" class="hidden flex-grow sm:flex items-end gap-4"><div><label for="start-date" class="block text-sm font-medium mb-1">Start</label><input type="date" id="start-date" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none"></div><div><label for="end-date" class="block text-sm font-medium mb-1">End</label><input type="date" id="end-date" class="clay-inset w-full p-3 text-lg appearance-none focus:outline-none"></div></div></div><div class="w-full sm:w-auto mt-4 sm:mt-0"><button id="open-log-session-modal" class="clay-button clay-button-primary w-full px-6 py-4 text-lg">Log New Session</button></div></div></div>
                   <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
                     <div class="md:col-span-2 clay-card p-6 flex flex-col justify-center"><div class="flex items-center justify-between text-gray-600 mb-2"><h3 id="final-pay-label" class="text-lg font-semibold uppercase tracking-wider"></h3><i data-lucide="wallet" class="text-gray-500"></i></div><p id="final-pay" class="font-playfair text-6xl font-bold" style="color: #831843;">₱0.00</p></div>
                    <div class="md:col-span-3 grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <div class="clay-card p-4 flex flex-col justify-center text-center"><h3 id="live-duration-label" class="text-sm font-semibold uppercase tracking-wider text-gray-600"></h3><p id="live-duration" class="font-playfair text-3xl font-bold text-gray-800 mt-2">0.0 <span class="text-xl align-baseline">hrs</span></p></div>
                        <div class="clay-card p-4 flex flex-col justify-center text-center"><h3 id="base-pay-label" class="text-sm font-semibold uppercase tracking-wider text-gray-600"></h3><p id="base-pay" class="font-playfair text-3xl font-bold text-gray-800 mt-2">₱0.00</p></div>
                        <div class="clay-card p-4 flex flex-col justify-center text-center"><h3 id="branded-sold-label" class="text-sm font-semibold uppercase tracking-wider text-gray-600"></h3><p id="branded-sold" class="font-playfair text-3xl font-bold mt-2 text-gray-800">0</p></div>
                        <div class="clay-card p-4 flex flex-col justify-center text-center"><h3 id="free-size-sold-label" class="text-sm font-semibold uppercase tracking-wider text-gray-600"></h3><p id="free-size-sold" class="font-playfair text-3xl font-bold mt-2 text-gray-800">0</p></div>
                    </div>
                </div>
                <div class="clay-card p-6 mb-8"><h3 class="font-playfair text-2xl font-bold mb-4">Running Incentives</h3><div id="bonus-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div></div>
                <div class="clay-card overflow-hidden"><h2 id="logged-entries-title" class="text-xl p-6 font-bold font-playfair border-b-2 border-dashed border-lavender-300"></h2><div id="table-container" class="overflow-x-auto"><table class="w-full table-auto"><thead class="text-gray-600"><tr></tr></thead><tbody id="table-body"></tbody></table></div><div id="no-entries" class="text-center p-8 text-gray-500 hidden">No entries found for the selected filters.</div><div id="pagination-controls" class="p-4 flex items-center justify-between flex-wrap gap-2"><span id="page-info" class="text-sm"></span><div class="flex items-center gap-2"><button id="prev-page" class="clay-button p-2 disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="chevron-left"></i></button><button id="next-page" class="clay-button p-2 disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="chevron-right"></i></button></div></div></div>`;
            runDashboardLogic('seller');
        }

        async function runDashboardLogic(role) {
            const { profile } = state;
            const sellerFilter = document.getElementById('seller-filter');
            const dateFilter = document.getElementById('date-filter');
            const customDateFilters = document.getElementById('custom-date-filters');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const tableBody = document.getElementById('table-body');
            const tableHead = document.querySelector('#table-container thead tr');
            const noEntriesMessage = document.getElementById('no-entries');
            const paginationControls = document.getElementById('pagination-controls');
            const pageInfo = document.getElementById('page-info');
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            const finalPayEl = document.getElementById('final-pay');
            const liveDurationEl = document.getElementById('live-duration');
            const basePayEl = document.getElementById('base-pay');
            const brandedSoldEl = document.getElementById('branded-sold');
            // Corrected ID for free size items element based on HTML template
            const freeSizeSoldEl = document.getElementById('free-size-sold');
            const loggedEntriesTitle = document.getElementById('logged-entries-title');
            const bonusCardsContainer = document.getElementById('bonus-cards-container');

            let dashboardFilteredData = [];
            let dashboardSortConfig = { key: 'session_start_time', direction: 'desc' };
            let dashboardCurrentPage = 1;
            const dashboardEntriesPerPage = 5;

            async function showBonusDetailsModal(ruleId) {
                // Fetch rule from new rules tables
                const { data: rule, error } = await _supabase
                    .from('rules')
                    .select(`
                        *,
                        rule_sets (
                            name,
                            description,
                            is_active,
                            effective_start_date,
                            effective_end_date,
                            rule_types(name)
                        )
                    `)
                    .eq('id', ruleId)
                    .single();
                if (error || !rule) {
                    showAlert('Error', 'Could not fetch rule details: ' + (error ? error.message : 'Rule not found.'));
                    return;
                }

                // Populate the modal with the rule details from the new structure
                document.getElementById('bonus-details-name').textContent = rule.rule_name;
                document.getElementById('bonus-details-description').textContent = rule.rule_sets.description || 'No description provided for rule set.';
                document.getElementById('bonus-details-amount').textContent = `${state.globalSettings.default_currency_symbol || '₱'}${rule.payout_value.toFixed(2)} (${rule.payout_type.replace(/_/g, ' ')})`;
                document.getElementById('bonus-details-timeframe').textContent = rule.cadence ? rule.cadence.charAt(0).toUpperCase() + rule.cadence.slice(1) : 'N/A';
                document.getElementById('bonus-details-start').textContent = new Date(rule.rule_sets.effective_start_date).toLocaleDateString();
                document.getElementById('bonus-details-end').textContent = rule.rule_sets.effective_end_date ? new Date(rule.rule_sets.effective_end_date).toLocaleDateString() : 'Indefinite';

                const targetsList = document.getElementById('bonus-details-targets');
                targetsList.innerHTML = `
                    <li>${rule.criteria_field.replace(/_/g, ' ').toUpperCase()} ${rule.operator} ${rule.target_value}</li>
                `; // Show only this rule's criteria for now

                document.getElementById('bonus-rule-details-modal').classList.remove('hidden');
                document.getElementById('close-bonus-details-btn').onclick = () => {
                    document.getElementById('bonus-rule-details-modal').classList.add('hidden');
                };
            }

            async function renderBonusCards(performanceData, filterRange) {
                // Fetch active rule sets of type 'Bonus' and their rules
                const { data: bonusRuleSets, error: rsError } = await _supabase
                    .from('rule_sets')
                    .select(`id, name, description, effective_start_date, effective_end_date, is_active,
                                 rule_types(name), rules (id, rule_name, criteria_field, operator, target_value, payout_type, payout_value)`)
                    .eq('is_active', true)
                    .in('rule_type_id', (await _supabase.from('rule_types').select('id').eq('name', 'Bonus')).data.map(t => t.id)) // Get 'Bonus' rule type ID
                    .filter('effective_start_date', 'lte', new Date().toISOString())
                    .or('effective_end_date.is.null,effective_end_date.gte.' + new Date().toISOString());

                if (rsError) {
                    console.error('Error fetching bonus rule sets:', rsError.message);
                    bonusCardsContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full">Error loading incentives.</p>`;
                    return;
                }

                if (bonusRuleSets.length === 0) {
                    bonusCardsContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full">No active bonus incentives at the moment.</p>`;
                    return;
                }

                // Aggregate metrics from performanceData for current filter range
                const metrics = performanceData.reduce((acc, item) => {
                    acc.live_hours = (acc.live_hours || 0) + (item.live_duration_hours || 0);
                    acc.branded_items = (acc.branded_items || 0) + (item.branded_items_sold || 0);
                    acc.free_size_items = (acc.free_size_items || 0) + (item.free_size_items_sold || 0);
                    acc.total_revenue = (acc.total_revenue || 0) + (item.total_revenue || 0);
                    return acc;
                }, { duration: 0, basePay: 0, branded_items: 0, free_size_items: 0, total_revenue: 0 }); // Initialize with all relevant metrics

                bonusCardsContainer.innerHTML = bonusRuleSets.map(ruleSet => {
                    let totalEarnedInSet = 0;
                    let allRulesInSetMet = true; // Assume all rules in set must be met by default

                    if (ruleSet.rules && ruleSet.rules.length > 0) {
                        ruleSet.rules.forEach(rule => {
                            const metricValue = metrics[rule.criteria_field] || 0;
                            let ruleMet = false;

                            switch (rule.operator) {
                                case '>=': ruleMet = (metricValue >= rule.target_value); break;
                                case '>': ruleMet = (metricValue > rule.target_value); break;
                                case '=': ruleMet = (metricValue === rule.target_value); break;
                                case '<': ruleMet = (metricValue < rule.target_value); break;
                                case '<=': ruleMet = (metricValue <= rule.target_value); break;
                            }

                            if (!ruleMet) {
                                allRulesInSetMet = false; // If any rule in the set is not met, the entire set is not achieved
                            } else {
                                // If a rule is met, accumulate its payout for this ruleset
                                if (rule.payout_type === 'fixed_amount') {
                                    totalEarnedInSet += rule.payout_value;
                                } else if (rule.payout_type === 'percentage') {
                                    // For percentage, assume it applies to total_revenue for simplicity.
                                    totalEarnedInSet += (metrics.total_revenue || 0) * (rule.payout_value / 100);
                                } else if (rule.payout_type === 'per_unit') {
                                    // This part needs more specific logic to determine which 'unit' (branded/free_size/total)
                                    // For simplicity, let's assume it applies to total items (branded + free_size) if not specified
                                    totalEarnedInSet += (metrics.branded_items + metrics.free_size_items) * rule.payout_value;
                                }
                            }
                        });
                    } else {
                        allRulesInSetMet = false; // A rule set with no rules cannot be met
                    }

                    // For the display card, use ruleSet.id to show details of the entire ruleSet
                    return `
                        <div class="clay-card p-4 cursor-pointer" data-rulesetid="${ruleSet.id}">
                            <div class="flex justify-between items-start">
                                <h4 class="font-playfair font-bold text-lg mb-2">${ruleSet.name}</h4>
                                <div class="tooltip-container">
                                    <i data-lucide="info" class="h-5 w-5 text-gray-500"></i>
                                    <span class="tooltip-text">
                                        Type: ${ruleSet.rule_types.name}<br>
                                        Status: ${ruleSet.is_active ? 'Active' : 'Inactive'}<br>
                                        Effective: ${new Date(ruleSet.effective_start_date).toLocaleDateString()} to ${rule.effective_end_date ? new Date(ruleSet.effective_end_date).toLocaleDateString() : 'Indefinite'}<br>
                                        Rules: ${ruleSet.rules && ruleSet.rules.length > 0 ? ruleSet.rules.map(rule => `${rule.rule_name} (${rule.criteria_field.replace(/_/g, ' ')} ${rule.operator} ${rule.target_value})`).join('<br>') : 'No rules defined.'}
                                    </span>
                                </div>
                            </div>
                            <p class="font-bold text-3xl" style="color: #831843;">${state.globalSettings.default_currency_symbol || '₱'}${totalEarnedInSet.toFixed(2)}</p>
                            <p class="text-xs text-gray-500 mt-1">${ruleSet.rule_types.name} Incentive</p>
                        </div>
                    `;
                }).join('');

                document.querySelectorAll('[data-rulesetid]').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const ruleSetId = e.currentTarget.dataset.rulesetid;
                        showRuleSetDetailsModal(ruleSetId); // Show details for the entire rule set
                    });
                });

                lucide.createIcons();
            }

            async function update() {
                // Fetch base hourly pay from global_settings
                const baseHourlyPay = state.globalSettings.base_hourly_pay_seller || 0;
                const defaultCurrencySymbol = state.globalSettings.default_currency_symbol || '₱';

                let query = _supabase.from('logged_sessions').select('*, profiles!seller_id(full_name)');

                if (role === 'seller') {
                    query = query.eq('seller_id', profile.id);
                } else if (sellerFilter) {
                    const selectedSellerId = sellerFilter.value;
                    if (selectedSellerId !== 'all') {
                        query = query.eq('seller_id', selectedSellerId);
                    }
                }

                let range = { start: null, end: null };
                switch (dateFilter.value) {
                    case 'This Week': range = getWeekRange('this'); break;
                    case 'Last Week': range = getWeekRange('last'); break;
                    case 'This Month': range = getMonthRange('this'); break;
                    case 'Custom':
                        if (startDateInput.value && endDateInput.value) {
                            range.start = parseDateAsUTC(startDateInput.value);
                            range.end = parseDateAsUTC(endDateInput.value);
                            if (range.end) range.end.setUTCHours(23, 59, 59, 999);
                        }
                        break;
                    default: break;
                }
                if (range.start) query = query.gte('session_start_time', range.start.toISOString());
                if (range.end) query = query.lte('session_start_time', range.end.toISOString());

                const { data, error } = await query;
                if (error) { showAlert('Error', 'Could not fetch session data: ' + error.message); return; }

                dashboardFilteredData = data;

                const metrics = dashboardFilteredData.reduce((acc, item) => {
                    acc.duration += item.live_duration_hours || 0;
                    acc.basePay += (item.live_duration_hours || 0) * baseHourlyPay; // Use global setting for base pay
                    acc.branded_items += item.branded_items_sold || 0;
                    acc.free_size_items += item.free_size_items_sold || 0;
                    acc.total_revenue += item.total_revenue || 0;
                    return acc;
                }, { duration: 0, basePay: 0, branded_items: 0, free_size_items: 0, total_revenue: 0 });

                // Bonus calculation based on new rules system
                let totalBonusAmount = 0;
                const { data: activeBonusRuleSets, error: ruleSetError } = await _supabase
                    .from('rule_sets')
                    .select(`
                        rules (criteria_field, operator, target_value, payout_type, payout_value)
                    `)
                    .eq('is_active', true)
                    .in('rule_type_id', (await _supabase.from('rule_types').select('id').eq('name', 'Bonus')).data.map(t => t.id))
                    .filter('effective_start_date', 'lte', new Date().toISOString())
                    .or('effective_end_date.is.null,effective_end_date.gte.' + new Date().toISOString());

                if (ruleSetError) {
                    console.error('Error fetching active bonus rule sets for calculation:', ruleSetError.message);
                } else if (activeBonusRuleSets) {
                    activeBonusRuleSets.forEach(ruleSet => {
                        let allRulesInSetMet = true;
                        let payoutForThisSet = 0;

                        if (ruleSet.rules && ruleSet.rules.length > 0) {
                            ruleSet.rules.forEach(rule => {
                                const metricValue = metrics[rule.criteria_field] || 0;
                                let ruleMet = false;

                                switch (rule.operator) {
                                    case '>=': ruleMet = (metricValue >= rule.target_value); break;
                                    case '>': ruleMet = (metricValue > rule.target_value); break;
                                    case '=': ruleMet = (metricValue === rule.target_value); break;
                                    case '<': ruleMet = (metricValue < rule.target_value); break;
                                    case '<=': ruleMet = (metricValue <= rule.target_value); break;
                                }

                                if (!ruleMet) {
                                    allRulesInSetMet = false;
                                } else {
                                    // If a rule is met, accumulate its payout for this ruleset
                                    if (rule.payout_type === 'fixed_amount') {
                                        payoutForThisSet += rule.payout_value;
                                    } else if (rule.payout_type === 'percentage') {
                                        payoutForThisSet += (metrics.total_revenue || 0) * (rule.payout_value / 100);
                                    } else if (rule.payout_type === 'per_unit') {
                                        payoutForThisSet += (metrics.branded_items + metrics.free_size_items) * rule.payout_value;
                                    }
                                }
                            });
                        } else {
                            allRulesInSetMet = false; // A rule set without rules cannot be met
                        }

                        if (allRulesInSetMet) {
                            totalBonusAmount += payoutForThisSet;
                        }
                    });
                }

                await renderBonusCards(dashboardFilteredData, range); // This now uses `rules` from `rule_sets` for display

                const finalPay = metrics.basePay + totalBonusAmount;
                const sellerName = (role === 'admin' && sellerFilter && sellerFilter.value !== 'all') ? sellerFilter.options[sellerFilter.selectedIndex].text : profile.full_name;
                const isAllSellers = role === 'admin' && sellerFilter.value === 'all';

                finalPayLabel.textContent = "Final Pay";
                liveDurationLabel.textContent = "Live Duration";
                basePayLabel.textContent = "Base Pay";
                brandedSoldLabel.textContent = "Branded Sold";
                freeSizeSoldEl.textContent = "Free Size Sold"; // Corrected ID here
                loggedEntriesTitle.textContent = isAllSellers ? 'All Logged Entries' : `${sellerName}'s Logged Entries`;

                finalPayEl.textContent = `${defaultCurrencySymbol}${finalPay.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
                liveDurationEl.innerHTML = `${metrics.duration.toFixed(1)} <span class="text-xl align-baseline">hrs</span>`;
                basePayEl.textContent = `${defaultCurrencySymbol}${metrics.basePay.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
                brandedSoldEl.textContent = metrics.branded_items.toLocaleString();
                freeSizeSoldEl.textContent = metrics.free_size_items.toLocaleString();

                dashboardFilteredData.sort((a, b) => {
                    const aValue = a[dashboardSortConfig.key];
                    const bValue = b[dashboardSortConfig.key];
                    if (aValue < bValue) return dashboardSortConfig.direction === 'asc' ? -1 : 1;
                    if (aValue > bValue) return dashboardSortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
                renderDashboardTable();
                renderDashboardPagination();
                lucide.createIcons();
            }
            function renderDashboardTable() {
                tableHead.innerHTML = '';
                tableBody.innerHTML = '';
                const headers = [{ label: 'Date', key: 'session_start_time' }, { label: 'Duration', key: 'live_duration_hours' }, { label: 'Branded', key: 'branded_items_sold' }, { label: 'Free Size', key: 'free_size_items_sold' }];
                if (role === 'admin') {
                    headers.splice(1, 0, { label: 'Seller', key: 'profiles.full_name' });
                }
                headers.forEach(h => tableHead.appendChild(createSortableHeader(h.label, h.key)));
                const startIndex = (dashboardCurrentPage - 1) * dashboardEntriesPerPage;
                const paginatedData = dashboardFilteredData.slice(startIndex, startIndex + dashboardEntriesPerPage);
                noEntriesMessage.style.display = paginatedData.length === 0 ? 'block' : 'none';
                paginatedData.forEach((item, index) => {
                    const itemDate = new Date(item.session_start_time);
                    const row = document.createElement('tr');
                    row.className = 'transition-colors duration-200 hover:bg-primary-lavender/60 ' + (index % 2 !== 0 ? 'bg-[rgba(0,0,0,0.04)]' : '');
                    row.innerHTML = `<td class="p-4 whitespace-nowrap">${itemDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td> ${role === 'admin' ? `<td class="p-4 whitespace-nowrap">${item.profiles.full_name}</td>` : ''} <td class="p-4 whitespace-nowrap">${item.live_duration_hours !== null ? item.live_duration_hours.toFixed(2) : 'N/A'} hrs</td> <td class="p-4 whitespace-nowrap">${item.branded_items_sold !== null ? item.branded_items_sold : 'N/A'}</td> <td class="p-4 whitespace-nowrap">${item.free_size_items_sold !== null ? item.free_size_items_sold : 'N/A'}</td>`;
                    tableBody.appendChild(row);
                });
            }
            function renderDashboardPagination() {
                const totalPages = Math.ceil(dashboardFilteredData.length / dashboardEntriesPerPage);
                paginationControls.style.display = totalPages > 1 ? 'flex' : 'none';
                pageInfo.innerHTML = `Page <strong>${dashboardCurrentPage}</strong> of <strong>${totalPages}</strong>`;
                prevPageBtn.disabled = dashboardCurrentPage === 1;
                nextPageBtn.disabled = dashboardCurrentPage === totalPages;
            }
            function createSortableHeader(label, key) {
                const th = document.createElement('th');
                th.className = "p-4 text-left font-semibold uppercase tracking-wider text-xs cursor-pointer";
                th.dataset.key = key;
                const iconContainer = dashboardSortConfig.key === key ? `<i data-lucide="${dashboardSortConfig.direction === 'asc' ? 'chevron-up' : 'chevron-down'}" class="h-4 w-4 ml-1"></i>` : '<div class="h-4 w-4 ml-1 opacity-20"><i data-lucide="chevron-down"></i></div>';
                th.innerHTML = `<div class="flex items-center">${label}${iconContainer}</div>`;
                th.addEventListener('click', () => {
                    dashboardSortConfig.direction = (dashboardSortConfig.key === key && dashboardSortConfig.direction === 'asc') ? 'desc' : 'asc';
                    dashboardSortConfig.key = key;
                    dashboardCurrentPage = 1;
                    update();
                });
                return th;
            }

            if (role === 'admin' && sellerFilter) {
                const { data: sellers, error } = await _supabase.from('profiles').select('id, full_name').eq('role', 'seller').order('full_name');
                if (sellers) {
                    sellerFilter.innerHTML = `<option value="all">All Sellers</option>` + sellers.map(s => `<option value="${s.id}">${s.full_name}</option>`).join('');
                }
                sellerFilter.addEventListener('change', () => { dashboardCurrentPage = 1; update(); });
            } else if (role === 'seller') {
                const logSessionModal = document.getElementById('log-session-modal');
                const sessionLogForm = document.getElementById('session-log-form');
                const logSessionButton = document.getElementById('open-log-session-modal');


                logSessionButton.addEventListener('click', () => {
                    sessionLogForm.reset();
                    logSessionModal.classList.remove('hidden');
                });
                document.getElementById('cancel-log-session-btn').addEventListener('click', () => {
                    logSessionModal.classList.add('hidden');
                });

                sessionLogForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    submitBtn.disabled = true; // Disable button 
                    submitBtn.textContent = 'Submitting Log...'; // Show loading 

                    const startStr = document.getElementById('session-start').value;
                    const endStr = document.getElementById('session-end').value;
                    const branded = parseInt(document.getElementById('branded-items').value) || 0;
                    const freeSize = parseInt(document.getElementById('free-size-items').value) || 0;

                    if (!startStr || !endStr) {
                        showAlert('Error', 'Please select both a start and end time.');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Log';
                        return;
                    }
                    const startDate = new Date(startStr);
                    const endDate = new Date(endStr);
                    if (endDate <= startDate) {
                        showAlert('Error', 'End time must be after the start time.');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Log';
                        return;
                    }
                    const duration = (endDate - startDate) / (1000 * 60 * 60);

                    const newEntry = {
                        session_start_time: startDate.toISOString(),
                        session_end_time: endDate.toISOString(),
                        live_duration_hours: duration,
                        branded_items_sold: branded,
                        free_size_items_sold: freeSize,
                        seller_id: profile.id
                    };
                    const { error } = await _supabase.from('logged_sessions').insert(newEntry);
                    if (error) {
                        showAlert('Error', 'Could not log session: ' + error.message);
                    } else {
                        update();
                        logSessionModal.classList.add('hidden');
                        showAlert('Success', 'Your session has been logged successfully!');
                    }
                    submitBtn.disabled = false; // Re-enable
                    submitBtn.textContent = 'Submit Log';
                });
            }

            dateFilter.addEventListener('change', () => {
                const showCustom = dateFilter.value === 'Custom';
                customDateFilters.classList.toggle('hidden', !showCustom);
                if (role === 'seller') customDateFilters.classList.toggle('sm:flex', showCustom);
                if (!showCustom) { dashboardCurrentPage = 1; update(); }
            });
            startDateInput.addEventListener('change', () => { dashboardCurrentPage = 1; update(); });
            endDateInput.addEventListener('change', () => { dashboardCurrentPage = 1; update(); });
            prevPageBtn.addEventListener('click', () => { if (dashboardCurrentPage > 1) { dashboardCurrentPage--; renderDashboardTable(); renderDashboardPagination(); } });
            nextPageBtn.addEventListener('click', () => { const totalPages = Math.ceil(dashboardFilteredData.length / dashboardEntriesPerPage); if (dashboardCurrentPage < totalPages) { dashboardCurrentPage++; renderDashboardTable(); renderDashboardPagination(); } });

            await update();
        }

        // --- Scheduler Module (Full Implementation) ---
        async function initializeScheduler() {
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) return;
            // Destroy existing calendar instance before creating a new one to prevent duplicates/errors
            if (calendarInstance) { calendarInstance.destroy(); calendarInstance = null; }

            const bookingModal = document.getElementById('booking-modal');
            const eventDetailsModal = document.getElementById('event-details-modal');
            const bookingForm = document.getElementById('booking-form');
            const eventTitleInput = document.getElementById('event-title');
            const startTimeInput = document.getElementById('start-time');
            const cancelBookingBtn = document.getElementById('cancel-booking-btn');
            const eventDetailsTitle = document.getElementById('event-details-title');
            const eventDetailsTime = document.getElementById('event-details-time');
            const eventDetailsStatus = document.getElementById('event-details-status');
            const eventDetailsActions = document.getElementById('event-details-actions');
            const closeDetailsBtn = document.getElementById('close-details-btn');
            const bookSessionBtn = document.getElementById('book-session-btn');

            // New elements for finalize session modal
            const finalizeSessionModal = document.getElementById('finalize-session-modal');
            const finalizeSessionForm = document.getElementById('finalize-session-form');
            const finalSessionDurationEl = document.getElementById('final-session-duration');
            const cancelFinalizeSessionBtn = document.getElementById('cancel-finalize-session-btn');

            let currentSelectionInfo = null;
            let currentEventToActOn = null;
            const { profile } = state;

            const getEventClassName = (status) => {
                const classMap = { locked: 'event-locked', pending: 'event-pending', takeover: 'event-takeover', takeover_pending: 'event-takeover', live: 'bg-action-pink', ended: 'bg-gray-400' };
                return classMap[status] || 'event-pending';
            }

            const formatEvent = (dbEvent) => ({
                id: dbEvent.id,
                title: dbEvent.title,
                start: dbEvent.start_time,
                end: dbEvent.end_time,
                classNames: [getEventClassName(dbEvent.status)],
                extendedProps: {
                    owner_id: dbEvent.owner_id,
                    owner_name: dbEvent.owner_name,
                    status: dbEvent.status,
                    original_owner_name: dbEvent.original_owner_name,
                    requested_by_id: dbEvent.requested_by_id,
                    requested_by_name: dbEvent.requested_by_name,
                    current_live_session_id: dbEvent.current_live_session_id
                }
            });

            // Fetch events before rendering calendar
            const { data, error } = await _supabase.from('calendar_events').select('*');
            if (error) { showAlert('Error', 'Could not fetch calendar events: ' + error.message); return; }

            const initialEvents = data.map(formatEvent);

            calendarInstance = new FullCalendar.Calendar(calendarEl, {
                initialView: window.innerWidth < 768 ? 'dayGridWeek' : 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,dayGridWeek,timeGridDay'
                },
                firstDay: 3,
                dateClick: function (info) {
                    if (profile.role !== 'seller') {
                        showAlert('Permission Denied', 'Only sellers can book sessions.');
                        return;
                    }
                    // Prevent booking on past dates
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    if (info.date < today) { showAlert('Invalid Date', 'You cannot book a session in the past.'); return; }

                    // Check if the clicked date already has an event for this seller
                    const eventsOnDay = calendarInstance.getEvents().filter(event => {
                        return event.start.toDateString() === info.date.toDateString() && event.extendedProps.owner_id === profile.id && event.extendedProps.status !== 'ended';
                    });
                    if (eventsOnDay.length > 0) {
                        showAlert('Already Booked', 'You already have a session on this day. Please choose another day or manage your existing booking.');
                        return;
                    }

                    bookingForm.reset();
                    currentSelectionInfo = info;
                    eventTitleInput.value = profile.full_name;
                    bookingModal.classList.remove('hidden');
                },
                events: initialEvents,
                eventClick: async (info) => {
                    const activeEvent = info.event;
                    const props = activeEvent.extendedProps;
                    const isMine = props.owner_id === profile.id;
                    currentEventToActOn = activeEvent;

                    eventDetailsTitle.textContent = activeEvent.title;
                    eventDetailsTime.textContent = `From ${activeEvent.start.toLocaleTimeString()} to ${activeEvent.end.toLocaleTimeString()}`;
                    eventDetailsStatus.textContent = `Status: ${props.status.charAt(0).toUpperCase() + props.status.slice(1).replace('_', ' ')}`;
                    eventDetailsActions.innerHTML = '';

                    if (profile.role === 'admin') {
                        if (props.status === 'pending') {
                            eventDetailsActions.innerHTML = `<button id="approve-btn" class="clay-button clay-button-approve w-full p-4 text-xl">Approve</button><button id="deny-btn" class="clay-button clay-button-deny w-full p-4 text-xl">Deny</button>`;
                            document.getElementById('approve-btn').onclick = async () => {
                                const approveBtn = document.getElementById('approve-btn');
                                approveBtn.disabled = true; // Disable button 
                                approveBtn.textContent = 'Approving...'; // Show loading 
                                const { error: updateError } = await _supabase.from('calendar_events').update({ status: 'locked', title: props.owner_name }).eq('id', activeEvent.id);
                                if (updateError) showAlert('Error', 'Failed to approve booking: ' + updateError.message);
                                else showAlert('Success', 'Booking approved.');
                                eventDetailsModal.classList.add('hidden');
                            };
                            document.getElementById('deny-btn').onclick = async () => {
                                const denyBtn = document.getElementById('deny-btn');
                                denyBtn.disabled = true; // Disable button 
                                denyBtn.textContent = 'Denying...'; // Show loading 
                                const { error: deleteError } = await _supabase.from('calendar_events').delete().eq('id', activeEvent.id);
                                if (deleteError) showAlert('Error', 'Failed to deny booking: ' + deleteError.message);
                                else showAlert('Success', 'Booking denied.');
                                eventDetailsModal.classList.add('hidden');
                            };
                        } else if (props.status === 'locked') {
                            eventDetailsActions.innerHTML = `
                                <button id="force-cancel-btn" class="clay-button clay-button-deny w-full p-4 text-xl">Force Cancellation</button>
                                <button id="admin-go-live-btn" class="clay-button clay-button-primary w-full p-4 text-xl">Admin Force Go Live</button>
                            `;
                            document.getElementById('force-cancel-btn').onclick = async () => {
                                const forceCancelBtn = document.getElementById('force-cancel-btn');
                                forceCancelBtn.disabled = true; // Disable button 
                                forceCancelBtn.textContent = 'Cancelling...'; // Show loading 
                                const { error: updateError } = await _supabase.from('calendar_events').update({ status: 'takeover', title: 'NEEDS TAKEOVER', original_owner_name: props.owner_name }).eq('id', activeEvent.id);
                                if (updateError) showAlert('Error', 'Failed to force cancel session: ' + updateError.message);
                                else showAlert('Success', 'Session force-cancelled and marked for takeover.');
                                eventDetailsModal.classList.add('hidden');
                            };
                            document.getElementById('admin-go-live-btn').onclick = async () => {
                                const adminGoLiveBtn = document.getElementById('admin-go-live-btn');
                                adminGoLiveBtn.disabled = true; // Disable button 
                                adminGoLiveBtn.textContent = 'Going Live...'; // Show loading 
                                try {
                                    const { data: liveSessionId, error } = await _supabase.rpc('start_live_session', { p_calendar_event_id: activeEvent.id }); // 
                                    if (error) throw error;
                                    showAlert('Success', `Session for ${props.owner_name} is now LIVE!`);
                                    eventDetailsModal.classList.add('hidden');
                                } catch (err) {
                                    showAlert('Error', 'Failed to force go live: ' + err.message);
                                } finally {
                                    adminGoLiveBtn.disabled = false; // Re-enable
                                    adminGoLiveBtn.textContent = 'Admin Force Go Live';
                                }
                            };
                        } else if (props.status === 'live') {
                            eventDetailsActions.innerHTML = `<button id="admin-end-session-btn" class="clay-button clay-button-deny w-full p-4 text-xl">Admin Force End Session</button>`;
                            document.getElementById('admin-end-session-btn').onclick = async () => {
                                const adminEndSessionBtn = document.getElementById('admin-end-session-btn');
                                adminEndSessionBtn.disabled = true; // Disable button 
                                adminEndSessionBtn.textContent = 'Ending Session...'; // Show loading 
                                try {
                                    const { data: result, error } = await _supabase.rpc('end_live_session', { p_live_session_id: props.current_live_session_id }); // 
                                    if (error) throw error;
                                    showAlert('Success', `Live session for ${props.owner_name} force-ended.`);
                                    eventDetailsModal.classList.add('hidden');
                                } catch (err) {
                                    showAlert('Error', 'Failed to force end session: ' + err.message);
                                } finally {
                                    adminEndSessionBtn.disabled = false; // Re-enable
                                    adminEndSessionBtn.textContent = 'Admin Force End Session';
                                }
                            };
                        } else if (props.status === 'takeover_pending') {
                            eventDetailsActions.innerHTML = `<p class="text-center w-full text-gray-700 font-semibold">Takeover requested by: ${props.requested_by_name}</p><button id="approve-takeover-btn" class="clay-button clay-button-approve w-full p-4 text-xl">Approve Takeover</button>`;
                            document.getElementById('approve-takeover-btn').onclick = async () => {
                                const approveTakeoverBtn = document.getElementById('approve-takeover-btn');
                                approveTakeoverBtn.disabled = true; // Disable button 
                                approveTakeoverBtn.textContent = 'Approving Takeover...'; // Show loading 
                                const { error: updateError } = await _supabase.from('calendar_events').update({ status: 'locked', owner_id: props.requested_by_id, owner_name: props.requested_by_name, title: props.requested_by_name, requested_by_id: null, requested_by_name: null }).eq('id', activeEvent.id);
                                if (updateError) showAlert('Error', 'Failed to approve takeover: ' + updateError.message);
                                else showAlert('Success', 'Takeover approved. Session assigned to new seller.');
                                eventDetailsModal.classList.add('hidden');
                            };
                        } else {
                            eventDetailsActions.innerHTML = `<p class="text-center w-full text-gray-600">No admin actions for this state.</p>`;
                        }
                    } else if (profile.role === 'seller') {
                        if (isMine && props.status === 'locked') {
                            eventDetailsActions.innerHTML = `
                                <button id="go-live-btn" class="clay-button clay-button-primary w-full p-4 text-xl">Go Live!</button>
                                <button id="cancel-session-btn" class="clay-button clay-button-deny w-full p-4 text-xl">Cancel My Session</button>
                            `;
                            document.getElementById('go-live-btn').onclick = async () => {
                                const goLiveBtn = document.getElementById('go-live-btn');
                                goLiveBtn.disabled = true; // Disable button 
                                goLiveBtn.textContent = 'Going Live...'; // Show loading 
                                try {
                                    // Call the backend RPC function to start the live session
                                    const { data: liveSessionId, error } = await _supabase.rpc('start_live_session', { p_calendar_event_id: activeEvent.id }); // 
                                    if (error) throw error;
                                    state.activeLiveSession = { id: liveSessionId, calendar_event_id: activeEvent.id }; // Store live_session_id
                                    showAlert('Success', 'You are now LIVE!');
                                    eventDetailsModal.classList.add('hidden');
                                } catch (err) {
                                    showAlert('Error', 'Failed to go live: ' + err.message);
                                } finally {
                                    goLiveBtn.disabled = false; // Re-enable
                                    goLiveBtn.textContent = 'Go Live!';
                                }
                            };

                            // Two-step cancellation 
                            let cancelTimeout;
                            document.getElementById('cancel-session-btn').onclick = (e) => {
                                const btn = e.currentTarget;
                                if (btn.dataset.confirm === 'true') {
                                    clearTimeout(cancelTimeout);
                                    btn.disabled = true;
                                    btn.textContent = 'Cancelling...';
                                    _supabase.from('calendar_events').update({ status: 'takeover', title: 'NEEDS TAKEOVER', original_owner_name: props.owner_name }).eq('id', activeEvent.id)
                                        .then(({ error }) => {
                                            if (error) showAlert('Error', 'Failed to cancel session: ' + error.message);
                                            else {
                                                showAlert('Success', 'Session cancelled and marked for takeover.');
                                                eventDetailsModal.classList.add('hidden');
                                            }
                                        })
                                        .finally(() => {
                                            btn.disabled = false;
                                            btn.textContent = 'Cancel My Session';
                                            delete btn.dataset.confirm;
                                            btn.classList.remove('clay-button-deny');
                                        });
                                } else {
                                    btn.dataset.confirm = 'true';
                                    btn.textContent = 'Confirm Cancel?';
                                    btn.classList.add('clay-button-deny');
                                    cancelTimeout = setTimeout(() => {
                                        delete btn.dataset.confirm;
                                        btn.textContent = 'Cancel My Session';
                                        btn.classList.remove('clay-button-deny');
                                    }, 5000); // Revert after 5 seconds
                                }
                            };

                        } else if (isMine && props.status === 'live') {
                            eventDetailsActions.innerHTML = `<button id="end-session-btn" class="clay-button clay-button-primary w-full p-4 text-xl">End Session</button>`; // 
                            document.getElementById('end-session-btn').onclick = async () => {
                                const endSessionBtn = document.getElementById('end-session-btn');
                                endSessionBtn.disabled = true; // Disable button 
                                endSessionBtn.textContent = 'Ending Session...'; // Show loading 
                                try {
                                    // Call the backend RPC function to end the live session
                                    // The RPC now returns duration and other metrics 
                                    const { data: result, error } = await _supabase.rpc('end_live_session', { p_live_session_id: props.current_live_session_id }); // 
                                    if (error) throw error;

                                    // Store the result for the finalize modal
                                    state.activeLiveSession = {
                                        id: props.current_live_session_id,
                                        calendar_event_id: activeEvent.id,
                                        duration: result.live_duration_hours,
                                        branded_items_sold: result.branded_items_sold,
                                        free_size_items_sold: result.free_size_items_sold,
                                        total_revenue: result.total_revenue
                                    };

                                    finalSessionDurationEl.textContent = `Total Live Duration: ${state.activeLiveSession.duration.toFixed(1)} hours`;
                                    // Pre-fill fields if data came back (though RPC typically sends to new `logged_sessions` directly)
                                    document.getElementById('finalize-branded-items').value = state.activeLiveSession.branded_items_sold || 0;
                                    document.getElementById('finalize-free-size-items').value = state.activeLiveSession.free_size_items_sold || 0;
                                    document.getElementById('finalize-total-revenue').value = state.activeLiveSession.total_revenue || 0;


                                    finalizeSessionModal.classList.remove('hidden'); // 
                                    eventDetailsModal.classList.add('hidden');
                                } catch (err) {
                                    showAlert('Error', 'Failed to end session: ' + err.message);
                                } finally {
                                    endSessionBtn.disabled = false; // Re-enable
                                    endSessionBtn.textContent = 'End Session';
                                }
                            };
                        } else if (!isMine && props.status === 'takeover') {
                            eventDetailsActions.innerHTML = `<button id="claim-takeover-btn" class="clay-button clay-button-primary w-full p-4 text-xl">Claim This Session</button>`;
                            document.getElementById('claim-takeover-btn').onclick = async () => {
                                const claimTakeoverBtn = document.getElementById('claim-takeover-btn');
                                claimTakeoverBtn.disabled = true; // Disable button 
                                claimTakeoverBtn.textContent = 'Claiming...'; // Show loading 
                                const { error: updateError } = await _supabase.from('calendar_events').update({ status: 'takeover_pending', requested_by_id: profile.id, requested_by_name: profile.full_name, title: `Takeover Pending (${profile.full_name})` }).eq('id', activeEvent.id);
                                if (updateError) showAlert('Error', 'Failed to claim session: ' + updateError.message);
                                else showAlert('Success', 'Takeover request sent for approval.');
                                eventDetailsModal.classList.add('hidden');
                            };
                        }
                        else {
                            eventDetailsActions.innerHTML = `<p class="text-center w-full text-gray-600">No actions available for you.</p>`;
                        }
                    }

                    eventDetailsModal.classList.remove('hidden');
                }
            });

            calendarInstance.render();

            bookingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true; // Disable button 
                submitBtn.textContent = 'Requesting...'; // Show loading 

                const startTimeValue = startTimeInput.value;
                // Get default session duration from global settings 
                const defaultSessionDurationHours = state.globalSettings.session_duration_hours || 3; // Default to 3 if not set

                if (startTimeValue && currentSelectionInfo) {
                    const [hours, minutes] = startTimeValue.split(':');
                    const startDateTime = new Date(currentSelectionInfo.date);
                    startDateTime.setHours(hours, minutes, 0, 0);
                    const endDateTime = new Date(startDateTime.getTime() + (defaultSessionDurationHours * 60 * 60 * 1000));

                    const overlappingEvents = calendarInstance.getEvents().filter(event => {
                        const eventStart = event.start.getTime();
                        const eventEnd = event.end.getTime();
                        return event.extendedProps.owner_id === profile.id && event.extendedProps.status !== 'ended' &&
                            ((startDateTime.getTime() < eventEnd && endDateTime.getTime() > eventStart));
                    });

                    if (overlappingEvents.length > 0) {
                        showAlert('Overlap Detected', 'This booking overlaps with an existing session. Please choose a different time.');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Request Booking';
                        return;
                    }

                    const newEvent = {
                        title: `${profile.full_name} (Pending)`,
                        start_time: startDateTime.toISOString(),
                        end_time: endDateTime.toISOString(),
                        status: 'pending',
                        owner_id: profile.id,
                        owner_name: profile.full_name,
                    };

                    const { error } = await _supabase.from('calendar_events').insert(newEvent);
                    if (error) showAlert('Error', 'Could not book session: ' + error.message);
                    else {
                        bookingModal.classList.add('hidden');
                        showAlert('Success', 'Booking request sent for approval!');
                    }
                }
                submitBtn.disabled = false; // Re-enable
                submitBtn.textContent = 'Request Booking';
            });
            cancelBookingBtn.addEventListener('click', () => bookingModal.classList.add('hidden'));
            closeDetailsBtn.addEventListener('click', () => eventDetailsModal.classList.add('hidden'));

            // Listener for Finalize Session Modal
            finalizeSessionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true; // Disable button 
                submitBtn.textContent = 'Submitting...'; // Show loading 

                const branded = parseInt(document.getElementById('finalize-branded-items').value) || 0;
                const freeSize = parseInt(document.getElementById('finalize-free-size-items').value) || 0;
                const totalRevenue = parseFloat(document.getElementById('finalize-total-revenue').value) || 0.00;
                const sessionNotes = document.getElementById('finalize-session-notes').value.trim();

                try {
                    // Call the backend RPC function to finalize the logged session 
                    const { error } = await _supabase.rpc('finalize_logged_session', {
                        p_live_session_id: state.activeLiveSession.id,
                        p_branded_items_sold: branded,
                        p_free_size_items_sold: freeSize,
                        p_total_revenue: totalRevenue,
                        p_session_notes: sessionNotes || null,
                        p_seller_id: state.profile.id // Ensure seller_id is passed as required by RPC 
                    });
                    if (error) throw error;
                    showAlert('Success', 'Sales data submitted successfully!');
                    finalizeSessionModal.classList.add('hidden');
                    state.activeLiveSession = null; // Clear active session state
                } catch (err) {
                    showAlert('Error', 'Failed to submit sales data: ' + err.message);
                } finally {
                    submitBtn.disabled = false; // Re-enable
                    submitBtn.textContent = 'Submit Sales Data';
                }
            });

            cancelFinalizeSessionBtn.addEventListener('click', () => {
                finalizeSessionModal.classList.add('hidden');
                state.activeLiveSession = null;
            });

            // Real-time listener for calendar events
            const eventChannel = _supabase.channel('public:calendar_events')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'calendar_events' }, payload => {
                    if (payload.eventType === 'INSERT') {
                        calendarInstance.addEvent(formatEvent(payload.new));
                    } else if (payload.eventType === 'UPDATE') {
                        let existingEvent = calendarInstance.getEventById(payload.new.id);
                        if (existingEvent) existingEvent.remove();
                        calendarInstance.addEvent(formatEvent(payload.new));
                    } else if (payload.eventType === 'DELETE') {
                        let existingEvent = calendarInstance.getEventById(payload.old.id);
                        if (existingEvent) existingEvent.remove();
                    }
                })
                .subscribe();
            channels.push(eventChannel);
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // This is critical for modals to be present in the DOM immediately
            modalContainer.innerHTML = Object.values(modalTemplates).join('');

            _supabase.auth.onAuthStateChange((event, session) => {
                checkUserSession();
            });

            document.body.addEventListener('click', (e) => {
                const pageButton = e.target.closest('[data-page]');
                if (pageButton) {
                    e.preventDefault();
                    if (!profileDropdown.classList.contains('hidden')) {
                        profileDropdown.classList.add('hidden');
                    }
                    showPage(pageButton.getAttribute('data-page'));
                }
            });

            profileButton.addEventListener('click', () => {
                profileDropdown.classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => {
                if (!profileButton.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
